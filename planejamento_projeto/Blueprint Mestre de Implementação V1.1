# ApostaCerta.AI - Blueprint Mestre de Implementa√ß√£o V1.1 (Vers√£o Chat Revisada)

**Data da Vers√£o:** 31 de maio de 2025
**Vers√£o do Blueprint:** 1.1 (Revisado conforme discuss√£o em chat)
**Status:** Pronto para implementa√ß√£o e evolu√ß√£o cont√≠nua

## 1. PROMPT MESTRE PARA QUALQUER IA (Guia de Implementa√ß√£o ApostaCerta.AI V1.1)

"Ol√°, IA! Voc√™ √© o especialista encarregado da implementa√ß√£o e evolu√ß√£o cont√≠nua do projeto **apostacerta.AI**, Vers√£o 1.1.

Sua miss√£o √© me auxiliar na constru√ß√£o dos fluxos de trabalho no N8N. Este projeto √© um chatbot de an√°lise de apostas esportivas via WhatsApp, orquestrado pelo N8N, utilizando Evolution API para comunica√ß√£o, Supabase como banco de dados (j√° configurado conforme o schema fornecido em `c√≥digo postgresql.txt` atualizado) e voc√™ (IA Generativa como GPT-4/Claude/Gemini) para l√≥gica de neg√≥cios e an√°lise contextual.

**Documentos de Refer√™ncia Prim√°ria (Internalize-os):**

1.  **`Scopo detalhado.txt` (V1.1):** Define O QU√ä o sistema deve fazer, funcionalidades, regras de neg√≥cio e a experi√™ncia do usu√°rio. √â a fonte da verdade para os requisitos. (Fornecido pelo usu√°rio)
2.  **`c√≥digo postgresql.txt` (ATUALIZADO):** Cont√©m o schema COMPLETO e ATUALIZADO do banco de dados Supabase, incluindo as novas colunas na tabela `users`. Todas os nomes de tabelas e colunas para intera√ß√µes com o banco DEVEM seguir este schema. (Fornecido pelo usu√°rio e atualizado conforme discuss√£o)
3.  **Este Documento (Blueprint Mestre de Implementa√ß√£o V1.1 - Vers√£o Chat Revisada):** Descreve COMO implementar a arquitetura, os agentes, as "tools" e os fluxos N8N. √â o seu guia principal para a implementa√ß√£o.

**Seu Entendimento √© Crucial:**
Confirme que voc√™ compreendeu a vis√£o geral do projeto, a arquitetura multi-agentes proposta, as tecnologias envolvidas, os princ√≠pios de design dos agentes (uso de "tools" pela IA, outputs simplificados dos agentes, gera√ß√£o de sum√°rio dedicada) e a import√¢ncia dos documentos de refer√™ncia. Voc√™ deve SEMPRE consultar estes documentos para manter o contexto e fornecer a melhor assist√™ncia.

**Estado Atual do Projeto:**
O banco de dados Supabase est√° implantado com o schema ATUALIZADO de `c√≥digo postgresql.txt`. A Evolution API est√° configurada e pronta para integra√ß√£o. O `Scopo detalhado.txt` define as funcionalidades da V1.1.

**Meu Foco Imediato √©:**
Estou trabalhando na **[NOME/N√öMERO DA FASE ATUAL DO PLANO DE IMPLEMENTA√á√ÉO]** e, mais especificamente, na tarefa de **[DESCRI√á√ÉO DA TAREFA ESPEC√çFICA EM N8N]**.

**Como Voc√™ Vai me Ajudar Agora:**
Com base no meu foco imediato, e seguindo os princ√≠pios deste Blueprint revisado, quero que voc√™ me ajude a:
    a. Esbo√ßar a sequ√™ncia de n√≥s N8N para esta tarefa espec√≠fica.
    b. Detalhar a configura√ß√£o dos n√≥s chave (especialmente n√≥s de IA, LangChain Agent, Tools N8N, Supabase/PostgreSQL e HTTP Request).
    c. Formular os System Messages para os n√≥s de IA dos agentes especializados (ex: Onboarding), garantindo que:
        * Eles instruam a IA a focar na conversa e a decidir usar "Tools" nomeando-as.
        * Eles instruam a IA a fornecer os argumentos necess√°rios para as tools, conforme as descri√ß√µes das tools.
        * A IA seja instru√≠da a retornar APENAS a `response_text` para o usu√°rio.
    d. Sugerir como tratar condi√ß√µes, l√≥gicas de ramifica√ß√£o e erros nesse fluxo espec√≠fico.
    e. Garantir que o input para o sub-fluxo `persistencia-e-log-pos-agente.n8n` (que agora inclui uma AI Summarizer) seja corretamente preparado.

Vamos come√ßar com a tarefa **[DESCRI√á√ÉO DA TAREFA ESPEC√çFICA EM N8N]** da **[NOME/N√öMERO DA FASE ATUAL]**. Apresente suas sugest√µes para o fluxo N8N e os System Messages/prompts relevantes."

---

## 2. DOCUMENTOS DE REFER√äNCIA PRIM√ÅRIA

1.  **`Scopo detalhado.txt` (Vers√£o 1.1):** Fornecido pelo usu√°rio. Define os requisitos funcionais, regras de neg√≥cio e a experi√™ncia do usu√°rio.
2.  **`c√≥digo postgresql.txt` (ATUALIZADO):** Fornecido pelo usu√°rio e atualizado em discuss√£o. Cont√©m o schema completo e atualizado do banco de dados Supabase, incluindo as colunas `stake_sugerida_percentual`, `stake_sugerida_valor`, e `total_apostas_diarias_recomendadas` na tabela `users`. √â a fonte da verdade para todas as intera√ß√µes com o banco.
3.  **`Blueprint Mestre de Implementa√ß√£o V1.1` (Este Documento - Vers√£o Chat Revisada):** Guia central para a arquitetura, design de agentes, "tools" e implementa√ß√£o dos fluxos N8N.

---

## 3. VIS√ÉO GERAL DO PROJETO

* **Conceito Central:** Sistema multi-agentes N8N que usa Advanced AI com prompts inteligentes como l√≥gica de neg√≥cio, substituindo IF/Switch por decis√µes contextuais da IA, para um chatbot de an√°lise de apostas esportivas via WhatsApp.
* **Objetivo (V1.1):** Automatizar e enriquecer a experi√™ncia de apostadores esportivos, fornecendo an√°lises estat√≠sticas e recomenda√ß√µes baseadas em IA diretamente no WhatsApp. Auxiliar na tomada de decis√µes mais informadas, no gerenciamento de banca personalizado (com base em perfis de risco e metas), na disciplina emocional (com alertas de perdas), atrav√©s de uma interface conversacional intuitiva, eficiente e contextualizada.
* **Fluxo Principal do Usu√°rio (Conforme V1.1):**
    * **Onboarding:** Coleta de dados essenciais (`bank_value`, `daily_goal_value`, `goal_timeframe_days`, `investor_profile`, `favorite_teams`). C√°lculo e armazenamento de `stake_sugerida_percentual`, `stake_sugerida_valor`, `total_apostas_diarias_recomendadas` e `onboarding_completed_at`.
    * **Menu Principal:** Apresenta√ß√£o de jogos dispon√≠veis, op√ß√µes de perfil, ajuda, etc.
    * **An√°lise de Jogo:** Consumo de cr√©dito (para nova an√°lise), busca de dados estat√≠sticos, gera√ß√£o de an√°lise pela IA, intera√ß√£o contextual sobre o jogo.
    * **Retorno Gratuito:** Acesso a an√°lises de jogos j√° pagos sem custo adicional enquanto relevantes.
    * **Controle de Perdas:** Alertas proativos ap√≥s perdas consecutivas.
    * **Feedback de Apostas:** Coleta de feedback do usu√°rio sobre o resultado de suas apostas em jogos analisados.

---

## 4. ARQUITETURA T√âCNICA

* **Stack Tecnol√≥gico:**
    * **Orquestrador:** N8N (workflows visuais)
    * **Comunica√ß√£o:** Evolution API (WhatsApp)
    * **Banco de Dados:** Supabase (PostgreSQL - schema no `c√≥digo postgresql.txt` ATUALIZADO)
    * **Intelig√™ncia Artificial:** Google Gemini (via `@n8n/n8n-nodes-langchain.lmChatGoogleGemini` ou chamadas HTTP diretas, se necess√°rio)
    * **Dados Esportivos:** Football API-Sports (API Key e plano sob responsabilidade do cliente)
    * **Autentica√ß√£o (Usu√°rio no DB):** Supabase Auth (`user_id` √© UUID, `DEFAULT auth.uid()` com trigger de fallback para `gen_random_uuid()` para chamadas de servi√ßo N8N).
* **Arquitetura Multi-Agentes (N8N):**
    * `Webhook (Evolution API)` ‚Üí `00-tratamento-inicial-mensagem.n8n` (seu fluxo atual de tratamento de mensagem e debounce) ‚Üí `01-hub-central.n8n` (Roteador AI) ‚Üí `Execute Workflow (Agente Especializado .n8n)` ‚Üí `Retorno do Agente Especializado (response_text)` ‚Üí `Bloco de Envio de Mensagem ao Usu√°rio (no 01-hub-central.n8n)` ‚Üí `Execute Workflow (subfluxo_persistencia_e_log_pos_agente.n8n)`.

---

## 5. ESTRUTURA DO BANCO DE DADOS (REFER√äNCIA) - ATUALIZADO

A fonte da verdade para a estrutura do banco de dados √© o arquivo **`c√≥digo postgresql.txt` (ATUALIZADO)**. Ele inclui as novas colunas na tabela `users`. Todas as opera√ß√µes de banco de dados devem seguir este schema.

**Tabelas Principais para Intera√ß√£o dos Agentes:**

* **`users`**: Armazena dados do perfil do usu√°rio, configura√ß√µes de apostas, cr√©ditos, estado do onboarding, etc.
    * Campos chave (incluindo os adicionados pela V1.1): `user_id`, `whatsapp_id`, `push_name`, `bank_value`, `daily_goal_value`, `goal_timeframe_days`, `investor_profile`, `favorite_teams`, `remaining_credits`, `credits_last_reset_at`, `recent_loss_signals_count`, `active_analysis_game_id`, `active_analysis_details`, `current_subscription_id`, `onboarding_completed_at`, `last_favorite_team_notification_at`, `stake_sugerida_percentual`, `stake_sugerida_valor`, `total_apostas_diarias_recomendadas`, `created_at`, `updated_at`.
* **`interaction_log`**: Registra cada intera√ß√£o significativa.
    * Campo `details (JSONB)`: Armazenar√° o `current_interaction_summary` gerado pela AI Summarizer, no formato `{"summary": "texto do sum√°rio"}`.
* Outras tabelas (`user_bets`, `leagues`, `plans`, `user_subscriptions`, `knowledge_base`, `app_settings`) permanecem conforme definidas no `c√≥digo postgresql.txt` atualizado.

---

## 6. PRINC√çPIOS DE DESIGN DOS AGENTES E FLUXOS N8N - ATUALIZADO

Esta se√ß√£o define como os agentes N8N devem ser constru√≠dos e como eles interagem, refletindo nossas √∫ltimas decis√µes.

### 6.1. Agentes como Orquestradores de "Tools"

* **IA Principal do Agente (LangChain Agent):** O n√≥ `@n8n/n8n-nodes-langchain.agent` de cada agente especializado (ex: "Agente Onboarding") √© respons√°vel pela l√≥gica da conversa, entendimento da inten√ß√£o do usu√°rio e decis√£o de quais "Tools" N8N chamar. A IA indicar√° o nome da tool e os argumentos necess√°rios, guiada pelas descri√ß√µes das tools configuradas no n√≥ LangChain Agent.
* **"Tools":** S√£o sub-fluxos N8N reutiliz√°veis (chamados via `@n8n/n8n-nodes-langchain.toolWorkflow`) ou "Code Tools" (JavaScript direto na configura√ß√£o da tool) que executam tarefas at√¥micas (ex: atualizar Supabase, chamar API externa, realizar c√°lculos).

### 6.2. Output Padronizado de um Agente Especializado (ex: Onboarding, Menu) - ATUALIZADO

Cada agente especializado, ao final de seu processamento para um turno de intera√ß√£o (ap√≥s potencialmente chamar v√°rias tools), produzir√° para o workflow `01-hub-central.n8n` um output contendo:

* **`response_text` (String):**
    * A mensagem exata a ser enviada ao usu√°rio via WhatsApp. Esta √© a principal e geralmente √∫nica sa√≠da direta da IA do agente especializado.
* **(Opcional) `output_para_proxima_tool_ou_log` (Object | String):**
    * Se o agente acabou de executar uma tool interna (como `Tool_CalculateStake`) e precisa que esses dados espec√≠ficos (o objeto de resultado da tool) sejam usados imediatamente pela pr√≥xima tool na sequ√™ncia definida no System Message (ex: `Tool_UpdateUserProfile`), ele pode passar esse resultado. Alternativamente, o sistema N8N pode gerenciar a passagem desses resultados de tool para a pr√≥xima chamada de tool com base nas instru√ß√µes do System Message do agente.

### 6.3. Contexto para os Agentes (Inputs Essenciais) - ATUALIZADO

Cada agente principal (Roteador e Especializados) deve receber um conjunto padronizado de inputs, tipicamente preparados pelo n√≥ `Preparar dados roteador` no `01-hub-central.n8n` ou pelo n√≥ "Start" do workflow do agente especializado:

* **`user_data` (Object):** Dados completos e mais recentes do usu√°rio, carregados da tabela `users`.
* **`final_user_message` (String):** A mensagem textual exata enviada pelo usu√°rio no turno atual (anteriormente referida como `incoming_message`).
* **`short_term_context_history` (Array[String]):** Um array contendo os `current_interaction_summary` das N intera√ß√µes mais recentes (gerados pela "AI Summarizer").
* **`AGORA √â:` (String):** O timestamp atual no formato ISO, para refer√™ncia (ex: para `onboarding_completed_at`).
* **(Implicitamente)** Acesso √† Mem√≥ria da Conversa via n√≥ "Postgres Chat Memory" configurado no agente LangChain.

### 6.4. Sub-fluxo N8N Padr√£o: `persistencia-e-log-pos-agente.n8n` (Responsabilidades ATUALIZADAS)

Este workflow N8N reutiliz√°vel √© chamado pelo `01-hub-central.n8n` AP√ìS a mensagem do agente especializado ter sido enviada ao usu√°rio.

* **Inputs Esperados:**
    * `user_id` (String/UUID)
    * `final_user_message` (String - a mensagem original do usu√°rio para o turno)
    * `agent_response_text` (String - a resposta que o agente especializado gerou e foi enviada ao usu√°rio)
    * `event_type` (String, opcional, default: "interaction\_processed")
* **Responsabilidades ATUALIZADAS:**
    1.  **Chamar "AI Summarizer":** Um n√≥ de IA (ex: Google Gemini) dentro deste sub-fluxo recebe `final_user_message` e `agent_response_text`. Ele usa um prompt espec√≠fico para gerar uma string `current_interaction_summary` concisa.
    2.  **Salvar Log de Intera√ß√£o:** Usa um n√≥ Supabase/PostgreSQL para inserir um novo registro na tabela `interaction_log` com `user_id`, `timestamp (NOW())`, `event_type` e o `current_interaction_summary` gerado (armazenado no campo `details` como `{"summary": "texto do sum√°rio"}`).
* Este sub-fluxo n√£o processa mais o objeto `database_updates` diretamente dos agentes especializados, pois as atualiza√ß√µes de banco s√£o feitas por "Tools" chamadas pelos pr√≥prios agentes.

### 6.5. Fluxos de Dados Padronizados (Geral) - ATUALIZADO

* O output dos Agentes Especializados para o `01-hub-central.n8n` √© agora primariamente a `response_text`.

---

T√≥pico para Adicionar ao seu Documento de Planejamento/Blueprint
Pode adicionar esta nova se√ß√£o ao seu documento, por exemplo, como 4.5 se estiver seguindo a estrutura do blueprint.

## 4.5. Integra√ß√£o Multicanal e Abstra√ß√£o da Camada de Mensageria

Para expandir o alcance e a flexibilidade do ApostaCerta.AI, o sistema foi refatorado para suportar m√∫ltiplos canais de comunica√ß√£o, iniciando com a integra√ß√£o do **WhatsApp (via Evolution API)** e do **Telegram**.

A estrat√©gia arquitet√¥nica adotada foi a cria√ß√£o de uma **camada de abstra√ß√£o de mensageria**, evitando a duplica√ß√£o da l√≥gica de neg√≥cio para cada canal. Isso foi alcan√ßado atrav√©s da defini√ß√£o de um **formato de mensagem can√¥nico (padr√£o)** que √© usado internamente por todo o sistema, desde o Roteador (01-hub-central.n8n) at√© os agentes especializados.

O fluxo de comunica√ß√£o agora segue o seguinte modelo:

#### 1. Ingress (Recebimento de Mensagens)

Cada canal possui um webhook de entrada dedicado (ex: \00-webhook-evolution.n8n`, `00-webhook-telegram.n8n`).`
A responsabilidade de cada webhook √© exclusivamente receber a mensagem no formato nativo da sua plataforma e **transform√°-la para o formato can√¥nico interno**.
Este objeto can√¥nico, contendo informa√ß√µes padronizadas como \sender_id`, `message_text`, e `platform`, √© ent√£o encaminhado para o `01-hub-central.n8n`.`
#### 2. Egress (Envio de Respostas)

Os agentes especializados geram uma resposta em um formato gen√©rico, sem se preocupar com o canal de destino.
Um m√≥dulo de envio centralizado recebe essa resposta gen√©rica, identifica a plataforma de origem do usu√°rio (WhatsApp ou Telegram) e **traduz a resposta para o formato espec√≠fico exigido pela API do canal** antes de envi√°-la ao usu√°rio final.
#### Diagrama do Fluxo de Mensageria

                                      +-------------------------+
[Webhook WhatsApp] -----------------> |                         |
                                      | M√≥dulo de Transforma√ß√£o |-----> [01-hub-central.n8n] --> (Agentes)
[Webhook Telegram] -----------------> | (Para Formato Can√¥nico) |
                                      |                         |
[Futuro Canal]--(futuro)------------> +-------------------------+
                                                ^
                                                | (Resposta Can√¥nica)
                                                |
                                      +-------------------------+
                                      |   M√≥dulo de Envio       |-----> (API Espec√≠fica da Plataforma)
                                      |   (Para Formato Nativo) |
                                      +-------------------------+
#### Vantagens Desta Arquitetura

**Escalabilidade:** Adicionar um novo canal no futuro (ex: Discord, Messenger) requer apenas a cria√ß√£o de um novo webhook de transforma√ß√£o, sem a necessidade de alterar a l√≥gica de neg√≥cio principal dos agentes.
**Manuten√ß√£o Simplificada:** A l√≥gica de neg√≥cio e as regras de conversa√ß√£o residem em um √∫nico lugar, sendo independentes do canal de comunica√ß√£o.
**Desacoplamento:** Os agentes n√£o precisam "saber" se est√£o conversando com um usu√°rio no WhatsApp ou no Telegram, o que torna o sistema mais limpo e robusto.


## 7. SISTEMA DE ROTEAMENTO INTELIGENTE (HUB CENTRAL) - ATUALIZADO

O workflow `01-hub-central.n8n` √© o ponto de entrada ap√≥s o `00-tratamento-inicial-mensagem.n8n`.

**Responsabilidades e Fluxo ATUALIZADOS:**

1.  Recebe os dados processados do `00-tratamento-inicial-mensagem.n8n` (incluindo `final_user_message`, `whatsapp_id`, `push_name`).
2.  Executa `Tool:FetchOrCreateUser` (sub-fluxo N8N) -> retorna `user_data`, `is_new_user`.
3.  Executa `Tool:FetchInteractionHistory` (sub-fluxo N8N) -> retorna `short_term_context_history`.
4.  N√≥ "Preparar dados roteador" (Set): Agrupa `user_data`, `is_new_user`, `short_term_context_history`, `final_user_message`, e `AGORA √â: {{ $now.toISO() }}`.
5.  N√≥ "AI Agent Router" (LangChain Agent + Gemini):
    * **Inputs:** Output do "Preparar dados roteador".
    * **System Message (Prompt Core do Roteador):** (Utilizar o System Message completo e corrigido que foi fornecido na conversa, que usa `user_data.onboarding_completed_at` para a descri√ß√£o do status e `is_new_user` na l√≥gica de decis√£o, e espera apenas o nome do agente como sa√≠da).
    * **Output:** Nome do agente especializado em min√∫sculas (ex: "onboarding").
6.  N√≥ "Switch" (DirecionarParaAgente): Usa a sa√≠da do Roteador AI para direcionar o fluxo.
7.  Para cada ramifica√ß√£o do Switch (ex: ramifica√ß√£o "onboarding"):
    a.  N√≥ "Execute Workflow": Chama o workflow do agente especializado (ex: `onboarding.n8n`), passando os dados preparados (output do "Preparar dados roteador").
    b.  O agente especializado (`onboarding.n8n`) executa sua l√≥gica, chama suas tools internas, e retorna APENAS a `response_text` para o usu√°rio.
    c.  N√≥(s) de Envio de Mensagem (seu bloco Code5, Reposta da orquestra, Switch1 para tipo de m√≠dia, SEND TEXT/IMAGE/VIDEO, Limit, Redis6): Pega a `response_text` retornada pelo agente especializado e envia para o usu√°rio via Evolution API.
    d.  N√≥ "Execute Workflow": Chama o sub-fluxo `persistencia-e-log-pos-agente.n8n`, passando `user_id` (de `user_data`), `final_user_message` (original do turno), e `agent_response_text` (que acabou de ser enviada).

---

## 8. AGENTES ESPECIALIZADOS - ATUALIZADO

Cada agente especializado (Onboarding, Menu, An√°lise Nova, An√°lise Ativa, Utilit√°rios, Controle de Perdas) √© um workflow N8N separado, implementado usando um n√≥ `@n8n/n8n-nodes-langchain.agent` conectado a um LLM (ex: Google Gemini) e ao "Postgres Chat Memory".

**Princ√≠pio Chave ATUALIZADO para Todos os Agentes Especializados:**

* **Entradas:** Recebem o contexto completo (`user_data`, `final_user_message`, `short_term_context_history`, `AGORA √â:`).
* **L√≥gica Interna:** O System Message de cada agente o instrui a conduzir a conversa, validar dados e, quando necess√°rio, decidir usar "Tools" configuradas. Ao decidir usar uma tool, a IA deve fornecer os argumentos necess√°rios para essa tool, conforme as descri√ß√µes dos par√¢metros da tool (configuradas no n√≥ `@n8n/n8n-nodes-langchain.toolWorkflow` ou "Code Tool").
* **Sa√≠da Principal para o `01-hub-central.n8n`:** APENAS a `response_text` (a mensagem a ser enviada ao usu√°rio). Eles n√£o geram mais `current_interaction_summary` nem `database_updates` diretamente em sua sa√≠da.

### 8.1. Agente Onboarding (`onboarding.n8n`) - ATUALIZADO

* **Fun√ß√£o:** Guiar o usu√°rio pela coleta de dados (`bank_value`, `daily_goal_value`, etc.), chamar tools para salvar esses dados e para calcular a stake.
* **System Message (Prompt Core):** (Utilizar o System Message completo e atualizado que foi fornecido na conversa, que instrui a IA sobre as ETAPAS DO ONBOARDING, como validar dados, como decidir usar `Tool_UpdateUserProfile` especificando `field_key_to_update` e `new_field_value`, como usar `Tool_CalculateStake`, e como, na ETAPA 7b, fazer m√∫ltiplas chamadas √† `Tool_UpdateUserProfile` para salvar os 3 resultados do c√°lculo de stake + `onboarding_completed_at`).
* **Tools Utilizadas (configuradas no n√≥ LangChain Agent "onboarding"):**
    * `Tool_UpdateUserProfile` (implementada como um `@n8n/n8n-nodes-langchain.toolWorkflow` que chama o sub-fluxo `subfluxo_tool_UpdateUserProfile.n8n`)
    * `Tool_CalculateStake` (implementada como um "Code Tool" JavaScript diretamente na configura√ß√£o da tool no agente "onboarding")
* **Output para `01-hub-central.n8n`:** Apenas `response_text`.

*(As se√ß√µes para os outros agentes como `menu.n8n`, `analise-nova.n8n`, etc., precisariam ser detalhadas seguindo este mesmo padr√£o de design, cada um com seu System Message espec√≠fico, l√≥gica de conversa e conjunto de tools que podem chamar).*

---

## 9. CAT√ÅLOGO DE "TOOLS" (Sub-Fluxos N8N Reutiliz√°veis ou N√≥s Especializados) - ATUALIZADO

Estas s√£o as "ferramentas" que os Agentes LangChain podem chamar.

* **`Tool:FetchOrCreateUser`** (Sub-fluxo N8N chamado pelo `01-hub-central.n8n` - Design permanece o mesmo).
* **`Tool:FetchInteractionHistory`** (Sub-fluxo N8N chamado pelo `01-hub-central.n8n` - Design permanece o mesmo, mas o `SELECT` agora √© `details->>'summary' AS interaction_summary`).
* **`Tool:SendMessageToUser`** (Implementado como um bloco de n√≥s HTTP Request no `01-hub-central.n8n`).
* **`Tool_UpdateUserProfile`**:
    * **Implementa√ß√£o:** N√≥ `@n8n/n8n-nodes-langchain.toolWorkflow` configurado no agente especializado (ex: Onboarding). Este n√≥ aponta para um sub-fluxo N8N (`subfluxo_tool_UpdateUserProfile.n8n`).
    * **Sub-fluxo `subfluxo_tool_UpdateUserProfile.n8n`**:
        * **Inputs** (recebidos do n√≥ LangChain tool): `user_id`, `field_key_to_update` (string), `new_field_value` (any).
        * **L√≥gica Interna:** Usa um n√≥ "Code" para preparar o objeto de atualiza√ß√£o e um n√≥ PostgreSQL com query din√¢mica parametrizada (sem ponto e v√≠rgula no final) para executar o `UPDATE users SET "[field_key_to_update]" = $1, "updated_at" = NOW() WHERE "user_id" = $2 RETURNING *;`.
        * **Output** (do sub-fluxo para o LangChain Agent/LLM): String de confirma√ß√£o (ex: `{ "output": "Campo [field_key_to_update] atualizado com sucesso." }`).
* **`Tool_CalculateStake`**:
    * **Implementa√ß√£o:** Diretamente como um "Code Tool" (JavaScript) dentro da configura√ß√£o da tool no n√≥ LangChain Agent (ex: no agente Onboarding).
    * **Inputs** (que a IA fornece para a tool, guiada pela descri√ß√£o da tool): `bank_value` (number), `investor_profile` (string).
    * **L√≥gica Interna (JavaScript):** C√≥digo que calcula `stake_sugerida_percentual`, `stake_sugerida_valor`, `total_apostas_diarias_recomendadas`.
    * **Output** (do c√≥digo JavaScript para o LangChain Agent/LLM): Uma string JSON contendo o objeto com os resultados. Ex: `JSON.stringify({stake_sugerida_percentual: 0.05, stake_sugerida_valor: 50, total_apostas_diarias_recomendadas: 3})`.
* **Nota Importante P√≥s-Tool (Tratamento do Output no Agente Onboarding):** O System Message do Agente Onboarding (ETAPA 7b) instrui a IA que, ap√≥s a `Tool_CalculateStake` ser executada, o sistema N8N disponibilizar√° os resultados (`stake_sugerida_percentual`, `stake_sugerida_valor`, `total_apostas_diarias_recomendadas`) no contexto para ela usar nas chamadas subsequentes √† `Tool_UpdateUserProfile`. Isso implica que, no workflow `onboarding.n8n`, ap√≥s o n√≥ da `Tool_CalculateStake` retornar a string JSON, pode ser necess√°rio um n√≥ "Code" ou "Set" para fazer `JSON.parse()` nessa string e transformar os resultados em campos acess√≠veis antes que a IA prossiga para as pr√≥ximas decis√µes de chamar `Tool_UpdateUserProfile`. Alternativamente, a IA pode ser instru√≠da a parsear a string JSON em seu pr√≥prio "pensamento" se o modelo for capaz.

*(O sub-fluxo `persistencia-e-log-pos-agente.n8n` agora tem uma fun√ß√£o diferente, como descrito na Se√ß√£o 6.4, e n√£o √© uma "tool" chamada pelos agentes especializados para persistir dados, mas sim um passo final no Hub Central para logar a intera√ß√£o completa).*

---

## 10. SISTEMA DE CR√âDITOS

* **Consumo:** 1 cr√©dito por NOVA an√°lise de jogo (quando `Tool:GetFootballGameStatistics` ou `Tool:GenerateSportAnalysisAI` √© chamada pela primeira vez para um `fixture_id` espec√≠fico para aquele usu√°rio, no dia ou per√≠odo relevante).
* **Retorno Gratuito:** An√°lise ativa ou retorno a um jogo j√° pago (identificado por `Tool:CheckRecentlyAnalyzedGames`) n√£o consome cr√©dito adicional.
* **Reset/Recarga:** Cr√©ditos podem ser resetados diariamente (via `reset-credits.n8n` agendado) ou atribu√≠dos conforme planos/regras de neg√≥cio (ex: X cr√©ditos no onboarding). Tabela `users.credits_last_reset_at` pode controlar o reset di√°rio.
* **Controle:** `Tool:ConsumeCredit` √© chamada pelo Agente "An√°lise Nova". O Agente verifica `user_data.remaining_credits` antes.

---

## 11. ESTRUTURA DOS WORKFLOWS N8N (Organiza√ß√£o de Arquivos)


workflows/
‚îú‚îÄ‚îÄ 00-tratamento-inicial-mensagem.n8n # Seu fluxo atual de webhook, debounce, etc.
‚îú‚îÄ‚îÄ 01-hub-central.n8n                 # Roteador AI principal
‚îú‚îÄ‚îÄ agentes/
‚îÇ   ‚îú‚îÄ‚îÄ onboarding.n8n
‚îÇ   ‚îú‚îÄ‚îÄ menu.n8n
‚îÇ   ‚îú‚îÄ‚îÄ analise-nova.n8n
‚îÇ   ‚îú‚îÄ‚îÄ analise-ativa.n8n
‚îÇ   ‚îú‚îÄ‚îÄ utilitarios.n8n
‚îÇ   ‚îî‚îÄ‚îÄ controle-perdas.n8n
‚îú‚îÄ‚îÄ tools/                             # Sub-fluxos N8N que implementam a l√≥gica das Tools
‚îÇ   ‚îú‚îÄ‚îÄ subfluxo_tool_UpdateUserProfile.n8n
‚îÇ   ‚îú‚îÄ‚îÄ subfluxo_tool_FetchGameList.n8n   # (Exemplo, se GetFootballGameList for um sub-fluxo)
‚îÇ   ‚îî‚îÄ‚îÄ subfluxo_tool_FetchGameStats.n8n  # (Exemplo)
‚îÇ   # Tool_CalculateStake √© um "Code Tool", n√£o um sub-fluxo aqui.
‚îú‚îÄ‚îÄ subfluxos_comuns/
‚îÇ   ‚îî‚îÄ‚îÄ subfluxo_persistencia_e_log_pos_agente.n8n # ATUALIZADO
‚îî‚îÄ‚îÄ scheduled/
‚îî‚îÄ‚îÄ reset-credits.n8n


---

## 12. CONFIGURA√á√ÉO ADVANCED AI NODES / LANGCHAIN AGENT NODES

* **Provider:** google-gemini, openai, anthropic.
* **Model:** Especificar o modelo (ex: gemini-pro, gpt-4-turbo, claude-3-opus).
* **Temperature:**
    * Para Roteamento e decis√µes l√≥gicas: Baixa (ex: 0.1 - 0.3).
    * Para Gera√ß√£o de An√°lise Esportiva e Respostas Criativas: Moderada (ex: 0.5 - 0.7).
* **Max Tokens:** Ajustar conforme a complexidade da tarefa e o output esperado.
* **Response Format:** `json_object` quando a IA do agente precisa retornar a estrutura padronizada (`response_text`, `database_updates`, `current_interaction_summary`). `text` para respostas mais diretas dentro de algumas tools.
* **Tools (para LangChain Agent Nodes):** Configurar as "Tools" N8N ou "Code Tools" que o agente pode chamar.
    * **Nome da Tool:** Um nome descritivo para a IA usar.
    * **Descri√ß√£o da Tool:** Uma descri√ß√£o clara para a IA entender o que a tool faz e quais argumentos ela espera. Esta descri√ß√£o √© crucial para a IA decidir usar a tool corretamente.
    * **ID do Workflow (para `@n8n/n8n-nodes-langchain.toolWorkflow`):** O ID do workflow N8N que implementa a tool.
    * **C√≥digo JavaScript (para "Code Tools"):** O c√≥digo que executa a l√≥gica da tool.
    * **Mapeamento de Inputs/Outputs:** Garantir que os argumentos que a IA fornece s√£o corretamente mapeados para os inputs do workflow/c√≥digo da tool, e que o output da tool √© retornado de forma que a IA possa utiliz√°-lo.

---

## 13. PROMPTS ESPECIALIZADOS (Exemplos) - ATUALIZADO

* **Prompt para `Tool:GenerateSportAnalysisAI`**
    ```
    Voc√™ √© um analista esportivo expert do apostacerta.AI. Sua tarefa √© fornecer uma an√°lise detalhada e imparcial do jogo de futebol solicitado, ou responder a uma pergunta espec√≠fica sobre ele, considerando o perfil do usu√°rio.

    JOGO PARA AN√ÅLISE:
    {{JSON.stringify(game_data_from_api_sports, null, 2)}}
    /* game_data_from_api_sports inclui:
    - Informa√ß√µes da partida (times, liga, data, placar atual se ao vivo)
    - Estat√≠sticas H2H recentes
    - Forma recente das equipes (√∫ltimos 5-10 jogos, resultados, gols)
    - Estat√≠sticas detalhadas da partida (se dispon√≠veis/ao vivo: posse, chutes, cantos, cart√µes, etc.)
    - Desfalques importantes (se dispon√≠veis)
    */

    PERFIL DO USU√ÅRIO:
    - Banca Atual: R$ {{user_data.bank_value}}
    - Perfil de Risco: {{user_data.investor_profile}} (Conservador, Equilibrado, Agressivo)
    - Stake Sugerida (calculada no onboarding): {{user_data.stake_sugerida_percentual}}% (aproximadamente R$ {{user_data.stake_sugerida_valor}})
    - Times Favoritos: {{JSON.stringify(user_data.favorite_teams)}}

    HIST√ìRICO RECENTE DA CONVERSA SOBRE ESTE JOGO (se houver):
    {{#each short_term_context_history_for_this_game}}
    - {{this}}
    {{/each}}

    FOCO DA AN√ÅLISE / PERGUNTA DO USU√ÅRIO (se aplic√°vel):
    "{{analysis_focus_question || 'Forne√ßa uma an√°lise geral e identifique uma oportunidade de aposta.'}}"

    INSTRU√á√ïES PARA A AN√ÅLISE:
    1.  **Contexto do Confronto (2-3 linhas):** Import√¢ncia do jogo, rivalidade, situa√ß√£o na tabela.
    2.  **An√°lise das Equipes:**
        * Desempenho recente, pontos fortes e fracos.
        * Como as estat√≠sticas (posse, chutes, xG se dispon√≠vel) refletem seu estilo de jogo.
        * Impacto de desfalques.
    3.  **Estat√≠sticas Chave Relevantes:** Destaque os dados mais importantes do `game_data_from_api_sports` que suportam sua an√°lise.
    4.  **Identifica√ß√£o de Oportunidade (se o foco for an√°lise geral):**
        * Sugira um mercado de aposta (ex: Resultado Final, Ambas Marcam, Total de Gols Over/Under, Handicap Asi√°tico, Marcadores).
        * Justifique a escolha com base na an√°lise e estat√≠sticas.
        * Indique uma faixa de odd que consideraria de valor (ex: "Odd m√≠nima sugerida: 1.85"). *N√£o prometa ganhos.*
    5.  **Recomenda√ß√£o de Stake (se aplic√°vel e uma oportunidade for identificada):**
        * Sugira um percentual da stake padr√£o do usu√°rio (ex: 0.5x, 1x, 1.5x da stake calculada no onboarding), justificando com base no n√≠vel de confian√ßa e no perfil de risco.
        * Ex: "Para seu perfil {{user_data.investor_profile}}, uma stake de {{0.5 * user_data.stake_sugerida_percentual}}% da sua banca (R$ {{0.5 * user_data.stake_sugerida_valor}}) seria prudente para esta aposta."
    6.  **Resposta √† Pergunta Espec√≠fica (se `analysis_focus_question` existir):** Responda diretamente √† pergunta do usu√°rio usando os dados dispon√≠veis.
    7.  **Alerta de Gest√£o de Banca:** SEMPRE inclua uma frase lembrando da import√¢ncia do gerenciamento de banca e de apostar com responsabilidade.
    8.  **Pergunta Engajante (Opcional, se for an√°lise geral):** Termine com uma pergunta para incentivar o usu√°rio a explorar mais algum aspecto (ex: "Gostaria de analisar as estat√≠sticas de escanteios ou o desempenho do artilheiro da equipe X?").

    TONE E ESTILO:
    - Objetivo, anal√≠tico e baseado em dados.
    - Imparcial, mesmo que um dos times seja favorito do usu√°rio.
    - Linguagem clara e acess√≠vel para apostadores.
    - Evite jarg√µes excessivos sem explica√ß√£o.
    - NUNCA garanta resultados ou lucros. Enfatize que s√£o an√°lises e sugest√µes.

    FORMATO DA RESPOSTA (TEXTO):
    Produza um texto corrido e bem formatado para WhatsApp. Use emojis com modera√ß√£o para melhorar a legibilidade.
    ```
* **NOVO: Prompt para AI Summarizer (dentro do `subfluxo_persistencia_e_log_pos_agente.n8n`):**
    ```
    Dada a seguinte intera√ß√£o entre um usu√°rio e um bot:
    MENSAGEM DO USU√ÅRIO: "{{ $json.final_user_message }}"
    RESPOSTA DO BOT: "{{ $json.agent_response_text }}"

    Crie um resumo conciso desta intera√ß√£o em uma √∫nica frase curta para fins de log. O resumo deve capturar a a√ß√£o principal ou a informa√ß√£o chave trocada. N√£o inclua sauda√ß√µes ou frases introdut√≥rias no resumo, apenas o fato principal. O resumo n√£o deve exceder 150 caracteres.

    Exemplos de resumo:
    - Usu√°rio perguntou sobre jogos, bot apresentou o menu.
    - Usu√°rio informou valor da banca R$1000, bot confirmou e pediu meta de lucro.
    - Bot iniciou an√°lise do jogo X vs Y.
    - Usu√°rio solicitou ajuda sobre comandos.
    ```

---

## 14. SISTEMA DE MONITORAMENTO

Logs Essenciais (Tabela `interaction_log`):

* `user_id`, `timestamp`, `event_type` (ex: `onboarding_step`, `menu_displayed`, `analysis_requested`, `analysis_generated`, `credit_consumed`, `error_api_football`, `user_message_unclear`), `details` (contendo o `current_interaction_summary` e outros metadados relevantes da intera√ß√£o).

M√©tricas Importantes (a serem extra√≠das dos logs):

* Tempo de resposta por agente/tool.
* Taxa de conclus√£o do onboarding.
* Uso de cr√©ditos por usu√°rio/dia.
* Jogos/Ligas mais analisados.
* Taxa de "retorno gratuito" a an√°lises.
* Engajamento com o Agente de Controle de Perdas.
* Pontos de abandono no funil de intera√ß√£o.

---

## 15. PLANO DE IMPLEMENTA√á√ÉO (Fases Sugeridas) - NOTA SOBRE ATUALIZA√á√ÉO
*(A estrutura de Fases do seu blueprint original √© uma boa base. As principais mudan√ßas ser√£o nas tarefas internas de cada fase para refletir a nova arquitetura de como os Agentes LangChain chamam Tools e como o logging/summarizing acontece. Por exemplo, ao implementar os agentes especializados, o foco ser√° em definir seu System Message, as Tools que ele pode chamar (e os sub-fluxos/c√≥digos dessas tools), e sua l√≥gica de conversa√ß√£o, sabendo que ele s√≥ precisa retornar `response_text`.)*

* **Fase 0:** Setup e Funda√ß√£o (Parcialmente conclu√≠do por voc√™)
    * [X] Configurar Supabase (schema de `c√≥digo postgresql.txt` aplicado).
    * [X] Configurar Evolution API (pronta para integra√ß√£o).
    * [ ] Configurar N8N com n√≥s Advanced AI e acesso √†s APIs.
    * [ ] Configurar Football API (chave e plano).
    * [ ] Criar workflow `00-webhook-evolution.n8n`. (Nota: no seu blueprint atualizado, o nome √© `00-tratamento-inicial-mensagem.n8n`)
    * [ ] Implementar `Tool:FetchOrCreateUser` e `Tool:FetchInteractionHistory`.
* **Fase 1:** Hub Central + Roteador
    * [ ] Criar workflow `01-hub-central.n8n`.
    * [ ] Implementar Advanced AI Roteador (Prompt Core e l√≥gica de decis√£o).
    * [ ] Implementar sub-fluxo `persistencia-e-log-pos-agente.n8n`.
    * [ ] Implementar `Tool:SendMessageToUser`.
    * [ ] Testar roteamento b√°sico com dados mock para `user_data` e `short_term_context_history`.
* **Fase 2:** Agente Onboarding
    * [ ] Criar workflow `agentes/onboarding.n8n`.
    * [ ] Implementar o "Prompt Core" da IA do Agente Onboarding.
    * [ ] Desenvolver l√≥gica N8N para gerenciar as etapas do onboarding (coleta sequencial, valida√ß√£o).
    * [ ] Integrar com `Tool_UpdateUserProfile` (via sub-fluxo de persist√™ncia ou tool workflow).
    * [ ] Implementar `Tool_CalculateStake`.
    * [ ] Testes ponta a ponta do onboarding completo.
* **Fase 3:** Agente Menu e Listagem de Jogos
    * [ ] Criar workflow `agentes/menu.n8n`.
    * [ ] Implementar `Tool:GetFootballGameList` (ou `subfluxo_tool_FetchGameList.n8n`) e `Tool:CheckRecentlyAnalyzedGames`.
    * [ ] Implementar o "Prompt Core" da IA do Agente Menu para formata√ß√£o da lista de jogos e op√ß√µes.
    * [ ] Testar apresenta√ß√£o do menu, destaque de favoritos e jogos retorn√°veis.
* **Fase 4:** Agentes de An√°lise (Nova e Ativa) e Sistema de Cr√©ditos
    * [ ] Criar workflows `agentes/analise-nova.n8n` e `agentes/analise-ativa.n8n`.
    * [ ] Implementar `Tool:ConsumeCredit`.
    * [ ] Implementar `Tool:GetFootballGameStatistics` (ou `subfluxo_tool_FetchGameStats.n8n`).
    * [ ] Implementar `Tool:GenerateSportAnalysisAI` (com o prompt especializado).
    * [ ] Desenvolver "Prompt Core" e l√≥gica N8N para ambos os agentes de an√°lise.
    * [ ] Gerenciar estado de `active_analysis_game_id` e `active_analysis_details`.
    * [ ] Testar fluxo completo de an√°lise nova (com consumo de cr√©dito) e an√°lise ativa (gratuita, contextual).
* **Fase 5:** Agente Controle de Perdas e Utilit√°rios
    * [ ] Criar workflows `agentes/controle-perdas.n8n` e `agentes/utilitarios.n8n`.
    * [ ] Implementar l√≥gica de gatilho para controle de perdas.
    * [ ] Desenvolver "Prompt Core" e l√≥gica N8N para estes agentes.
    * [ ] Testar alertas de perda e funcionalidades de perfil/ajuda.
* **Fase 6:** Testes Integrados, Refinamento de Prompts e Otimiza√ß√£o
    * [ ] Testar todos os fluxos de ponta a ponta com m√∫ltiplos cen√°rios.
    * [ ] Ajustar prompts de IA com base nos resultados e qualidade das respostas.
    * [ ] Otimizar performance dos workflows N8N.
    * [ ] Revisar tratamento de erros e mensagens ao usu√°rio.
* **Fase 7:** Documenta√ß√£o Final e Prepara√ß√£o para Deploy
    * [ ] Finalizar documenta√ß√£o interna dos workflows N8N.
    * [ ] Preparar vari√°veis de ambiente para produ√ß√£o.

---

## 16. CHECKLIST DE VALIDA√á√ÉO (V1.1)

Funcionalidades Core:

* [ ] Usu√°rio completa onboarding (`bank_value`, `daily_goal_value`, `goal_timeframe_days`, `investor_profile`, `favorite_teams`), dados salvos, `stake_sugerida_percentual`, `stake_sugerida_valor`, `total_apostas_diarias_recomendadas` calculados e `onboarding_completed_at` preenchido.
* [ ] Roteador IA (`01-hub-central.n8n`) direciona corretamente para cada agente especializado com base no contexto (`user_data.onboarding_completed_at`, `is_new_user`, `final_user_message`, `short_term_context_history`).
* [ ] `short_term_context_history` (sum√°rios da AI Summarizer) √© corretamente carregado e utilizado pelos agentes.
* [ ] `current_interaction_summary` √© gerado pela AI Summarizer no `persistencia-e-log-pos-agente.n8n` de forma concisa e √∫til, e salvo em `interaction_log.details`.
* [ ] Sub-fluxo `persistencia-e-log-pos-agente.n8n` funciona corretamente (chama AI Summarizer, salva log).
* [ ] Agentes especializados retornam apenas `response_text` para o `01-hub-central.n8n`.
* [ ] `Tool_UpdateUserProfile` e `Tool_CalculateStake` (e outras tools) s√£o chamadas corretamente pelos agentes LangChain com os argumentos necess√°rios e seus outputs s√£o processados conforme o System Message do agente.
* [ ] Menu mostra jogos (Football API), destaca favoritos e retornos gratuitos (üîÅ).
* [ ] Nova an√°lise consome 1 cr√©dito, busca estat√≠sticas, IA gera an√°lise e √© enviada.
* [ ] Retorno √† an√°lise ativa √© gratuito e contextual.
* [ ] Agente Controle de Perdas alerta ap√≥s X perdas.
* [ ] Agente Utilit√°rios permite ver/alterar perfil e obter ajuda.
* [ ] Dados persistem corretamente no Supabase conforme `c√≥digo postgresql.txt` (ATUALIZADO).
* [ ] Integra√ß√£o com WhatsApp via Evolution API funciona para envio e recebimento.

Performance e Usabilidade:

* [ ] Tempo de resposta aceit√°vel (< 5-10 segundos para intera√ß√µes complexas com IA).
* [ ] Mensagens bem formatadas e claras no WhatsApp.
* [ ] Tratamento de erros amig√°vel (falhas de API, input inv√°lido, erros internos dos agentes ou tools).
* [ ] Logs de monitoramento (`interaction_log`) s√£o abrangentes e √∫teis para depura√ß√£o.

Seguran√ßa e Dados:

* [ ] RLS (Row Level Security) ativo e funcional no Supabase (conforme `c√≥digo postgresql.txt`).
* [ ] Chaves de API (Football API, IA, Evolution) protegidas como vari√°veis de ambiente no N8N.
* [ ] Dados do usu√°rio isolados corretamente.

---

## 17. RECURSOS E REFER√äNCIAS

* **APIs Utilizadas:** Football API-Sports, Supabase, Evolution API, Google Gemini (ou outro LLM como GPT/Claude).
* **Documenta√ß√£o N8N:**
    * LangChain Nodes (`@n8n/n8n-nodes-langchain.agent`, `@n8n/n8n-nodes-langchain.toolWorkflow`, `@n8n/n8n-nodes-langchain.lmChatGoogleGemini`, etc.)
    * HTTP Request Node
    * PostgreSQL Node (para Supabase)
    * Webhook Node
    * Execute Workflow Node (para sub-fluxos)
    * Set Node, Code Node, Switch Node
* **Documenta√ß√£o LangChain:** Conceitos de Agentes, Tools, Memory.
* **Documenta√ß√£o Supabase:** JavaScript Client Library, SQL.
* **Documenta√ß√£o Evolution API:** Endpoints para envio de mensagens.

---

## 18. TROUBLESHOOTING COMUM

* **Timeout APIs Externas (Football API, LLM):**
    * Aumentar timeout nos n√≥s HTTP Request ou n√≥s de IA.
    * Implementar retentativas com backoff exponencial no N8N (usando n√≥s de Erro e Retry).
    * Verificar cotas e limites das APIs.
* **Erro Supabase RLS ou Permiss√µes:**
    * Verificar pol√≠ticas de seguran√ßa (RLS) no `c√≥digo postgresql.txt` e no painel do Supabase.
    * Garantir que o usu√°rio/role da API N8N no Supabase tem as permiss√µes corretas (SELECT, INSERT, UPDATE nas tabelas necess√°rias).
* **WhatsApp n√£o recebe/envia mensagens:**
    * Verificar webhook da Evolution API no N8N (se est√° ativo e acess√≠vel).
    * Verificar status da inst√¢ncia da Evolution API.
    * Conferir o formato do payload enviado para a Evolution API.
    * Logs da Evolution API.
* **IA (LangChain Agent) n√£o chama a Tool esperada ou falha ao usar uma Tool:**
    * **Descri√ß√£o da Tool:** A descri√ß√£o da tool no n√≥ LangChain Agent deve ser MUITO clara e precisa sobre o que a tool faz e, crucialmente, quais argumentos ela espera e em que formato.
    * **System Message do Agente:** O prompt do agente deve guiar a IA sobre quando e como usar as tools dispon√≠veis.
    * **Argumentos da Tool:** Verificar se a IA est√° tentando chamar a tool com os argumentos corretos e no formato esperado pelo sub-fluxo N8N ou "Code Tool".
    * **Output da Tool:** O sub-fluxo ou "Code Tool" deve retornar um output (geralmente uma string, pode ser JSON stringificada) que a IA consiga entender e usar, conforme instru√≠do no System Message.
* **IA n√£o responde no formato esperado (ex: n√£o retorna apenas `response_text`):**
    * Ajustar o System Message do agente para ser expl√≠cito sobre o formato de sa√≠da desejado (ex: "Responda APENAS com o texto para o usu√°rio.").
    * Verificar a `temperature` do modelo de IA (valores mais baixos para respostas mais determin√≠sticas).
* **Contexto da IA Incorreto (`short_term_context_history` ou `user_data`):**
    * Depurar os dados que est√£o sendo efetivamente passados para o prompt da IA.
    * Verificar a qualidade e concis√£o dos `current_interaction_summary` gerados pela AI Summarizer. Se os sum√°rios forem ruins, o contexto de curto prazo ser√° ruim.
* **Erro no Output de "Code Tools" ou Parsing de JSON:**
    * Se uma "Code Tool" retorna uma string JSON e o agente LangChain n√£o consegue us√°-la, verifique:
        * Se a "Code Tool" est√° de fato retornando uma string JSON v√°lida (use `JSON.stringify()` corretamente no final do c√≥digo da tool).
        * Se o System Message do agente instrui a IA sobre como esperar e usar esse output (seja para passar para outra tool ou para extrair dados). A IA pode precisar ser instru√≠da que o output de uma tool ser√° uma string JSON que ela talvez precise "interpretar" para extrair valores para a pr√≥xima tool.
        * Se √© necess√°rio um n√≥ "Code" ou "Set" no workflow N8N *ap√≥s* o n√≥ LangChain Agent executar a "Code Tool" (se a tool for chamada e seu resultado precisar ser processado antes da IA continuar no mesmo turno) para fazer `JSON.parse()` na string e disponibilizar os dados de forma estruturada para a pr√≥xima chamada de tool pela IA. No entanto, o ideal √© que a IA seja instru√≠da a solicitar as chamadas subsequentes √† `Tool_UpdateUserProfile` (por exemplo) j√° com os valores extra√≠dos do JSON retornado pela `Tool_CalculateStake`.
* **Loop de Agente ou Decis√µes Inesperadas do Roteador:**
    * Revisar o prompt do Roteador AI e dos agentes, especialmente a l√≥gica de decis√£o e as condi√ß√µes de transi√ß√£o.
    * Verificar se o `short_term_context_history` est√° influenciando negativamente as decis√µes.

---

## 19. PR√ìXIMOS PASSOS PARA COME√áAR (Com este Blueprint)

1.  **Revis√£o Completa:** Revise este Blueprint Mestre V1.1 (Vers√£o Chat Revisada) para garantir que todos os aspectos est√£o cobertos e claros, especialmente a nova arquitetura de Agentes LangChain, Tools, e o fluxo de `response_text` e `persistencia-e-log-pos-agente.n8n`.
2.  **Configura√ß√£o do Ambiente N8N:**
    * Certifique-se de que o N8N est√° pronto.
    * Instale/atualize os pacotes LangChain (`@n8n/n8n-nodes-langchain`).
    * Configure as credenciais para Google Gemini (ou outro LLM), Supabase, e Evolution API no N8N.
3.  **Implementa√ß√£o Incremental (Conforme Faseamento):**
    * **Comece pelo `00-tratamento-inicial-mensagem.n8n` e `01-hub-central.n8n`:**
        * Implemente `Tool:FetchOrCreateUser` e `Tool:FetchInteractionHistory` como sub-fluxos.
        * Configure o n√≥ "AI Agent Router" no Hub Central com seu System Message.
        * Configure o Switch para direcionar para os futuros agentes (inicialmente podem ser stubs).
    * **Implemente o `subfluxo_persistencia_e_log_pos_agente.n8n`:**
        * Configure o n√≥ da AI Summarizer com seu prompt.
        * Configure o n√≥ Supabase para salvar na `interaction_log`.
    * **Desenvolva um Agente Especializado por vez (ex: `onboarding.n8n`):**
        * Crie o workflow do agente.
        * Configure o n√≥ LangChain Agent com seu System Message e as "Tools" que ele pode chamar (`Tool_UpdateUserProfile` via `toolWorkflow` e `Tool_CalculateStake` como "Code Tool").
        * Crie os sub-fluxos para as tools que s√£o workflows (ex: `subfluxo_tool_UpdateUserProfile.n8n`).
        * Teste o agente isoladamente e depois integrado com o Hub Central.
4.  **Foco nas "Tools" Primeiro:** Implemente e teste as "Tools" (sub-fluxos N8N e "Code Tools") individualmente para garantir que funcionam corretamente antes de integr√°-las aos agentes LangChain.
5.  **Itera√ß√£o nos Prompts (System Messages):** Os System Messages para o Roteador e para cada Agente Especializado s√£o CRUCIAIS. Eles necessitar√£o de v√°rias itera√ß√µes e testes para alcan√ßar a l√≥gica de conversa√ß√£o, o uso correto das tools e o formato de output desejado.
6.  **Valida√ß√£o Cont√≠nua:** Use o Checklist de Valida√ß√£o (Se√ß√£o 16) ao final de cada fase e antes do deploy final.

**IMPORTANTE:** Este blueprint √© um guia vivo. Conforme o projeto evolui e novos aprendizados surgem durante a implementa√ß√£o, ele pode (e deve) ser atualizado para refletir o estado mais recente e as melhores pr√°ticas identificadas.
