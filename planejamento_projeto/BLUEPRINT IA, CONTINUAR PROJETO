# ApostaCerta.AI - Blueprint Mestre de Implementa√ß√£o V1.1

**Data da Vers√£o:** 31 de maio de 2025
**Vers√£o do Blueprint:** 1.1
**Status:** Pronto para implementa√ß√£o e evolu√ß√£o cont√≠nua

## 1. PROMPT MESTRE PARA QUALQUER IA (Guia de Implementa√ß√£o ApostaCerta.AI V1.1)

"Ol√°, IA! Voc√™ √© o especialista encarregado da implementa√ß√£o e evolu√ß√£o cont√≠nua do projeto **apostacerta.AI**, Vers√£o 1.1.

Sua miss√£o √© me auxiliar na constru√ß√£o dos fluxos de trabalho no N8N. Este projeto √© um chatbot de an√°lise de apostas esportivas via WhatsApp, orquestrado pelo N8N, utilizando Evolution API para comunica√ß√£o, Supabase como banco de dados (j√° configurado conforme o schema fornecido) e voc√™ (IA Generativa como GPT-4/Claude/Gemini) para l√≥gica de neg√≥cios e an√°lise contextual.

**Documentos de Refer√™ncia Prim√°ria (Internalize-os):**

1.  **`Scopo detalhado.txt` (V1.1):** Define O QU√ä o sistema deve fazer, funcionalidades, regras de neg√≥cio e a experi√™ncia do usu√°rio. √â a fonte da verdade para os requisitos. (Fornecido pelo usu√°rio)
2.  **`c√≥digo postgresql.txt`:** Cont√©m o schema COMPLETO e ATUALIZADO do banco de dados Supabase. Todos os nomes de tabelas e colunas para intera√ß√µes com o banco DEVEM seguir este schema. (Fornecido pelo usu√°rio)
3.  **Este Documento (Blueprint Mestre de Implementa√ß√£o V1.1):** Descreve COMO implementar a arquitetura, os agentes, as "tools" e os fluxos N8N. √â o seu guia principal para a implementa√ß√£o.

**Seu Entendimento √© Crucial:**
Confirme que voc√™ compreendeu a vis√£o geral do projeto, a arquitetura multi-agentes proposta, as tecnologias envolvidas, os princ√≠pios de design dos agentes (uso de "tools", outputs padronizados, gest√£o de contexto) e a import√¢ncia dos documentos de refer√™ncia. Voc√™ deve SEMPRE consultar estes documentos para manter o contexto e fornecer a melhor assist√™ncia.

**Estado Atual do Projeto:**
O banco de dados Supabase est√° implantado com o schema de `c√≥digo postgresql.txt`. A Evolution API est√° configurada e pronta para integra√ß√£o. O `Scopo detalhado.txt` define as funcionalidades da V1.1.

**Meu Foco Imediato √©:**
Estou trabalhando na **[NOME/N√öMERO DA FASE ATUAL DO PLANO DE IMPLEMENTA√á√ÉO]** e, mais especificamente, na tarefa de **[DESCRI√á√ÉO DA TAREFA ESPEC√çFICA EM N8N]**.

**Como Voc√™ Vai me Ajudar Agora:**
Com base no meu foco imediato, e seguindo os princ√≠pios deste Blueprint, quero que voc√™ me ajude a:
    a. Esbo√ßar a sequ√™ncia de n√≥s N8N para esta tarefa espec√≠fica.
    b. Detalhar a configura√ß√£o dos n√≥s chave (especialmente n√≥s de IA, Function, Supabase e HTTP Request que atuar√£o como "Tools" ou ser√£o chamados por elas).
    c. Formular os prompts para os n√≥s de IA (sejam eles o "c√©rebro" do agente ou parte de uma "tool"), garantindo que:
        * Usem os nomes de campos corretos do Supabase (ex: `users.bank_value`, `users.investor_profile`).
        * Recebam o contexto necess√°rio (`user_data`, `incoming_message`, `short_term_context_history`).
        * Produzam os outputs padronizados (`response_text`, `database_updates`, `current_interaction_summary`).
    d. Sugerir como tratar condi√ß√µes, l√≥gicas de ramifica√ß√£o e erros nesse fluxo espec√≠fico.
    e. Garantir que o `current_interaction_summary` gerado seja conciso e √∫til para o `short_term_context_history`.

Vamos come√ßar com a tarefa **[DESCRI√á√ÉO DA TAREFA ESPEC√çFICA EM N8N]** da **[NOME/N√öMERO DA FASE ATUAL]**. Apresente suas sugest√µes para o fluxo N8N e os prompts relevantes."

---

## 2. DOCUMENTOS DE REFER√äNCIA PRIM√ÅRIA

1.  **`Scopo detalhado.txt` (Vers√£o 1.1):** Fornecido pelo usu√°rio. Define os requisitos funcionais, regras de neg√≥cio e a experi√™ncia do usu√°rio.
2.  **`c√≥digo postgresql.txt`:** Fornecido pelo usu√°rio. Cont√©m o schema completo do banco de dados Supabase. √â a fonte da verdade para todas as intera√ß√µes com o banco.
3.  **`Blueprint Mestre de Implementa√ß√£o V1.1` (Este Documento):** Guia central para a arquitetura, design de agentes, "tools" e implementa√ß√£o dos fluxos N8N.

## 3. VIS√ÉO GERAL DO PROJETO
*(Conforme o blueprint original fornecido pelo usu√°rio e o `Scopo detalhado.txt`)*

* **Conceito Central:** Sistema multi-agentes N8N que usa Advanced AI com prompts inteligentes como l√≥gica de neg√≥cio, substituindo IF/Switch por decis√µes contextuais da IA, para um chatbot de an√°lise de apostas esportivas via WhatsApp.
* **Objetivo (V1.1):** Automatizar e enriquecer a experi√™ncia de apostadores esportivos, fornecendo an√°lises estat√≠sticas e recomenda√ß√µes baseadas em IA diretamente no WhatsApp. Auxiliar na tomada de decis√µes mais informadas, no gerenciamento de banca personalizado (com base em perfis de risco e metas), na disciplina emocional (com alertas de perdas), atrav√©s de uma interface conversacional intuitiva, eficiente e contextualizada.
* **Fluxo Principal do Usu√°rio:**
    1.  **Onboarding:** Coleta de dados essenciais (`bank_value`, `daily_goal_value`, `goal_timeframe_days`, `investor_profile`, `favorite_teams`). C√°lculo e apresenta√ß√£o de stake sugerida.
    2.  **Menu Principal:** Apresenta√ß√£o de jogos dispon√≠veis (com destaque para times favoritos e jogos j√° analisados), op√ß√µes de perfil, ajuda, etc.
    3.  **An√°lise de Jogo:** Consumo de cr√©dito (para nova an√°lise), busca de dados estat√≠sticos, gera√ß√£o de an√°lise pela IA, intera√ß√£o contextual sobre o jogo.
    4.  **Retorno Gratuito:** Acesso a an√°lises de jogos j√° pagos sem custo adicional enquanto relevantes.
    5.  **Controle de Perdas:** Alertas proativos ap√≥s perdas consecutivas.
    6.  **Feedback de Apostas:** Coleta de feedback do usu√°rio sobre o resultado de suas apostas em jogos analisados.

## 4. ARQUITETURA T√âCNICA
*(Conforme o blueprint original fornecido pelo usu√°rio)*

* **Stack Tecnol√≥gico:**
    * **Orquestrador:** N8N (workflows visuais)
    * **Comunica√ß√£o:** Evolution API (WhatsApp)
    * **Banco de Dados:** Supabase (PostgreSQL - schema em `c√≥digo postgresql.txt`)
    * **Intelig√™ncia Artificial:** GPT-4, Claude, Gemini (via Advanced AI nodes ou chamadas HTTP)
    * **Dados Esportivos:** Football API-Sports (API Key e plano sob responsabilidade do cliente)
    * **Autentica√ß√£o (Usu√°rio no DB):** Supabase Auth (user\_id √© UUID, default `auth.uid()`)
* **Arquitetura Multi-Agentes (N8N):**
    * `Webhook (Evolution API)` ‚Üí `01-hub-central.n8n (Roteador AI)` ‚Üí `Agente Especializado (workflow .n8n)` ‚Üí `Sub-fluxo: Persist√™ncia e Log P√≥s-Agente` ‚Üí `Tool:SendMessageToUser (Evolution API)`

## 5. ESTRUTURA DO BANCO DE DADOS (REFER√äNCIA)

A fonte da verdade para a estrutura do banco de dados √© o arquivo **`c√≥digo postgresql.txt`**. Todos os nomes de tabelas e colunas DEVER√ÉO seguir este schema.

**Tabelas Principais para Intera√ß√£o dos Agentes:**

* **`users`**: Armazena dados do perfil do usu√°rio, configura√ß√µes de apostas, cr√©ditos, estado do onboarding, etc.
    * Campos chave: `user_id (UUID, PK)`, `whatsapp_id (TEXT, UNIQUE)`, `push_name (TEXT)`, `bank_value (DECIMAL)`, `daily_goal_value (DECIMAL)`, `goal_timeframe_days (INTEGER)`, `investor_profile (TEXT)`, `favorite_teams (JSONB)`, `remaining_credits (INTEGER)`, `recent_loss_signals_count (INTEGER)`, `active_analysis_game_id (TEXT)`, `active_analysis_details (JSONB)`, `onboarding_completed_at (TIMESTAMPTZ)`.
* **`interaction_log`**: Registra cada intera√ß√£o significativa do usu√°rio com o sistema.
    * Campos chave: `log_id (BIGSERIAL, PK)`, `user_id (UUID, FK)`, `timestamp (TIMESTAMPTZ)`, `event_type (TEXT)`, `details (JSONB)` (aqui ser√° armazenado o `current_interaction_summary`).
* **`user_bets`**: Hist√≥rico de apostas informadas pelo usu√°rio.
    * Campos chave: `bet_id (BIGSERIAL, PK)`, `user_id (UUID, FK)`, `game_id_api_football (TEXT)`, `bet_description (TEXT)`, `stake_amount (DECIMAL)`, `result (TEXT)`.
* **`leagues`**: Informa√ß√µes sobre ligas de futebol.
* **`plans` / `user_subscriptions`**: Para futuras funcionalidades de planos e assinaturas.

**Nota sobre Nomenclatura (Portugu√™s vs. Ingl√™s):**
* A interface com o usu√°rio (perguntas do bot, textos de ajuda) deve ser em Portugu√™s, conforme o `Scopo detalhado.txt` (ex: "Qual sua banca inicial?").
* Todas as opera√ß√µes de banco de dados, nomes de vari√°veis internas nos fluxos N8N e chaves em objetos JSON trocados entre n√≥s devem usar os nomes das colunas em Ingl√™s, conforme o `c√≥digo postgresql.txt` (ex: `bank_value`).
* A IA dos agentes ser√° respons√°vel por essa tradu√ß√£o/mapeamento ao formular perguntas e processar respostas.

## 6. PRINC√çPIOS DE DESIGN DOS AGENTES E FLUXOS N8N

Esta se√ß√£o define como os agentes N8N devem ser constru√≠dos e como eles interagem.

### 6.1. Agentes como Orquestradores de "Tools"
* **IA Principal do Agente:** O n√≥ de IA central de cada agente (ex: "Agente Onboarding") √© respons√°vel pela l√≥gica da conversa, entendimento da inten√ß√£o do usu√°rio (com base na mensagem e contexto), e decis√£o de quais "Tools" chamar.
* **"Tools":** S√£o sub-fluxos N8N reutiliz√°veis ou n√≥s N8N especializados e configurados (ex: N√≥ Supabase, N√≥ HTTP Request, N√≥ Function) que executam tarefas at√¥micas e bem definidas.
    * Exemplos: buscar dados no Supabase, chamar uma API externa, enviar uma mensagem formatada via Evolution API, realizar c√°lculos complexos.
* **Fluxo de Controle:** O Agente IA chama uma ou mais tools sequencialmente ou condicionalmente. Cada tool retorna dados estruturados para o Agente IA.
* **Formula√ß√£o da Resposta Final:** Ap√≥s receber e processar os resultados de todas as tools necess√°rias para o turno atual, a IA Principal do Agente formula a `response_text` final para o usu√°rio.

### 6.2. Output Padronizado de um Agente
Cada agente principal, ao final de seu processamento para um turno de intera√ß√£o, deve produzir um output JSON estruturado com os seguintes campos:

* **`response_text` (String | Null):**
    * A mensagem exata a ser enviada ao usu√°rio via WhatsApp.
    * Pode ser `null` se uma "Tool" espec√≠fica (ex: `Tool:SendMessageToUser`) j√° enviou a mensagem necess√°ria e o agente n√£o tem nada a acrescentar textualmente naquele turno (ex: apenas realizou uma atualiza√ß√£o de dados em background).
* **`database_updates` (Object | Null):**
    * Um objeto JSON especificando as altera√ß√µes a serem persistidas no Supabase. A estrutura deve facilitar a atualiza√ß√£o por um sub-fluxo gen√©rico.
    * Formato Exemplo:
        ```json
        {
          "users": { // Nome da tabela
            "update": { // Opera√ß√£o
              "pk_column": "user_id", // Coluna da chave prim√°ria
              "pk_value": "uuid-do-usuario", // Valor da chave prim√°ria
              "fields": { // Campos a serem atualizados
                "bank_value": 1000.50,
                "investor_profile": "equilibrado",
                "active_analysis_game_id": null
              }
            }
          },
          "user_bets": { // Outra tabela
            "insert": { // Opera√ß√£o
              "fields": {
                "user_id": "uuid-do-usuario",
                "game_id_api_football": "game123",
                "bet_description": "Vit√≥ria Time A",
                "stake_amount": 50
              }
            }
          }
        }
        ```
    * Pode ser `null` se nenhuma atualiza√ß√£o no banco de dados for necess√°ria.
* **`current_interaction_summary` (String):**
    * Um resumo textual **conciso e focado** da intera√ß√£o que acabou de ocorrer.
    * **Prop√≥sito Principal:**
        1.  Alimentar o `short_term_context_history` para a *pr√≥xima* intera√ß√£o do mesmo agente ou do Roteador.
        2.  Servir como um log de intera√ß√£o humano-leg√≠vel e √∫til na tabela `interaction_log.details`.
    * **Conte√∫do Ideal:**
        * Inten√ß√£o principal do usu√°rio na mensagem recebida.
        * A√ß√£o principal ou resposta chave do bot.
        * Dados cr√≠ticos coletados ou decis√µes importantes tomadas (ex: "Usu√°rio definiu banca como R$500", "An√°lise do jogo X iniciada").
        * Estado resultante ou pr√≥xima expectativa clara (ex: "Aguardando resposta sobre perfil de risco", "Menu principal apresentado").
    * **Deve ser breve e evitar redund√¢ncia** com os `user_data` completos que j√° s√£o carregados.
* **`next_module_or_state` (String | Null):** (Opcional)
    * Usado para transi√ß√µes expl√≠citas de estado interno do agente ou para indicar qual o pr√≥ximo agente/m√≥dulo deveria ser chamado pelo Roteador Central, se aplic√°vel.

### 6.3. Contexto para os Agentes (Inputs Essenciais)
Cada agente principal e o Roteador devem receber um conjunto padronizado de inputs para processamento:

* **`user_data` (Object):**
    * Objeto JSON contendo os dados completos e mais recentes do usu√°rio, carregados da tabela `users` do Supabase (e potencialmente outras tabelas relacionadas, se necess√°rio).
* **`incoming_message` (String):**
    * A mensagem textual exata enviada pelo usu√°rio no turno atual.
* **`short_term_context_history` (Array[String]):**
    * Um array contendo os `current_interaction_summary` das N intera√ß√µes mais recentes (ex: √∫ltimas 3-5).
    * Recuperado da tabela `interaction_log` (ordenado por `timestamp` DESC, limitado a N).
    * Este √© o mecanismo chave para fornecer contexto de curto prazo √† IA do agente.
* **`conversation_id` (String):**
    * Identificador da conversa (ex: `whatsapp_id` do usu√°rio).
* **`current_timestamp` (String):**
    * Timestamp atual (ISO 8601) para refer√™ncia.
* **`active_game_data` (Object | Null):** (Espec√≠fico para agentes de an√°lise)
    * Se houver um jogo em an√°lise ativa, este objeto conteria os detalhes carregados desse jogo.

### 6.4. Sub-fluxo N8N Padr√£o: "Persist√™ncia e Log P√≥s-Agente"
Um workflow N8N reutiliz√°vel, chamado **ap√≥s** cada agente principal concluir seu processamento e gerar seu output padronizado.

* **Inputs:** `user_id` (ou `whatsapp_id`), `database_updates` (objeto), `current_interaction_summary` (string).
* **Responsabilidades:**
    1.  **Executar Atualiza√ß√µes no Supabase:** Iterar sobre o objeto `database_updates`. Para cada tabela e opera√ß√£o (insert/update/delete), construir e executar a query correspondente usando o N√≥ Supabase.
    2.  **Salvar Log de Intera√ß√£o:** Inserir um novo registro na tabela `interaction_log` com `user_id`, `timestamp` (atual), `event_type` (pode ser gen√©rico como "agent\_interaction" ou mais espec√≠fico se fornecido pelo agente), e o `current_interaction_summary` no campo `details`.

### 6.5. Fluxos de Dados Padronizados (Geral)

**Input Padr√£o (para o Hub Central / Roteador AI):**
```json
{
  "conversation_id": "5511999999999", // Geralmente o whatsapp_id
  "push_name": "Jo√£o Silva", // Nome do usu√°rio no WhatsApp, se dispon√≠vel
  "message": "Quais os jogos de hoje?",
  "timestamp": "2025-05-31T14:30:00Z", // Timestamp da mensagem recebida
  "metadata": { // Metadados da plataforma de origem
    "message_type": "text",
    "platform": "whatsapp",
    "raw_message_payload": {} // Payload original da Evolution API
  }
}

Input Interno Padr√£o (para cada Agente Especializado, ap√≥s o Roteador e o carregamento de dados):

{
  "conversation_id": "5511999999999",
  "user_data": { // Carregado do Supabase - Tabela 'users' e potencialmente outros
    "user_id": "uuid-do-usuario",
    "whatsapp_id": "5511999999999",
    "push_name": "Jo√£o Silva",
    "onboarding_completed_at": "2025-05-30T10:00:00Z",
    "bank_value": 1000.00,
    "daily_goal_value": 100.00,
    "goal_timeframe_days": 10,
    "investor_profile": "equilibrado",
    "favorite_teams": ["Flamengo", "Santos"],
    "remaining_credits": 3,
    "recent_loss_signals_count": 1,
    "active_analysis_game_id": "game_123",
    "active_analysis_details": { /* ... */ }
    // ... todos os campos relevantes da tabela users
  },
  "incoming_message": "Quero analisar o jogo do Flamengo.",
  "short_term_context_history": [
    "Summary da intera√ß√£o N-2",
    "Summary da intera√ß√£o N-1: Usu√°rio pediu menu. Menu principal apresentado com 3 jogos."
  ],
  "current_timestamp": "2025-05-31T14:32:00Z",
  "jogos_disponiveis_api": [ /* Array de jogos da Football API, se j√° carregado pelo Menu ou Roteador */ ],
  "active_game_data": { /* Detalhes do jogo ativo, se houver */ }
}

Output Padr√£o (de cada Agente Especializado, antes do sub-fluxo de Persist√™ncia e Log):

{
  "agente_usado": "analise-nova", // Nome do agente que processou
  "response_text": "Analisando Flamengo x Palmeiras. Para come√ßar, voc√™ gostaria de um resumo das estat√≠sticas H2H ou a forma recente das equipes?",
  "database_updates": {
    "users": {
      "update": {
        "pk_column": "user_id",
        "pk_value": "uuid-do-usuario",
        "fields": {
          "remaining_credits": 2,
          "active_analysis_game_id": "game_flaxpal",
          "active_analysis_details": { "status": "iniciada", "jogo_info": { /*...*/ }}
        }
      }
    }
  },
  "current_interaction_summary": "Usu√°rio solicitou an√°lise do jogo Flamengo x Palmeiras. Cr√©dito consumido. An√°lise iniciada. Perguntado sobre foco inicial (H2H ou forma).",
  "next_module_or_state": null, // Ou, por exemplo, "aguardando_foco_analise"
  "metadata_processamento": { // Metadados sobre o processamento do agente
    "processing_time_ms": 1200,
    "tokens_used_ia": 245,
    "tools_called": ["Tool:FetchGameDetails", "Tool:ConsumeCredit"]
  }
}

7. SISTEMA DE ROTEAMENTO INTELIGENTE (HUB CENTRAL)
O workflow 01-hub-central.n8n √© o ponto de entrada ap√≥s o Webhook da Evolution API.

Responsabilidades:

Receber a mensagem do usu√°rio.

Tool Call: Tool:FetchOrCreateUser:

Input: whatsapp_id, push_name.

Output: user_data (completo, seja novo ou existente), is_new_user.

Tool Call: Tool:FetchInteractionHistory:

Input: user_id.

Output: short_term_context_history (√∫ltimas N intera√ß√µes).

Advanced AI Roteador (N√≥ de IA Principal do Hub):

Inputs: user_data, incoming_message, short_term_context_history, is_new_user.

Prompt Template (Roteador Principal):

Voc√™ √© o roteador inteligente do apostacerta.AI. Sua fun√ß√£o √© direcionar a mensagem do usu√°rio para o agente especializado correto.

CONTEXTO DO USU√ÅRIO:
- User ID: {{user_data.user_id}}
- Nome: {{user_data.push_name}}
- Onboarding Completo: {{user_data.onboarding_completed_at ? 'Sim' : 'N√£o'}}
- Cr√©ditos Restantes: {{user_data.remaining_credits}}
- Jogo em An√°lise Ativa (ID): {{user_data.active_analysis_game_id || 'Nenhum'}}
- Detalhes An√°lise Ativa: {{JSON.stringify(user_data.active_analysis_details) || 'Nenhum'}}

HIST√ìRICO RECENTE DA CONVERSA (√öLTIMAS INTERA√á√ïES):
{{#each short_term_context_history}}
- {{this}}
{{/each}}

MENSAGEM ATUAL DO USU√ÅRIO: "{{incoming_message}}"

AN√ÅLISE DE INTEN√á√ÉO E DIRECIONAMENTO:
Com base em todos os dados acima, especialmente o status do onboarding, se h√° uma an√°lise ativa, o hist√≥rico recente e a mensagem atual, determine a inten√ß√£o REAL do usu√°rio e qual agente deve tratar esta mensagem.

AGENTES DISPON√çVEIS:
- "onboarding": Para usu√°rios novos (onboarding_completed_at √© NULO) ou que explicitamente pedem para refazer/ver onboarding.
- "menu": Para mostrar op√ß√µes principais, listar jogos, se o usu√°rio pede para voltar ao menu ou se n√£o h√° inten√ß√£o clara para outro agente.
- "analise-nova": Se o usu√°rio quer analisar um jogo NOVO (e n√£o tem um ativo OU quer trocar o ativo). Requer cr√©ditos.
- "analise-ativa": Se o usu√°rio est√° interagindo sobre um jogo J√Å EM AN√ÅLISE ATIVA (user_data.active_analysis_game_id est√° preenchido e a mensagem √© sobre este jogo). N√£o consome cr√©dito.
- "controle-perdas": (Gatilho especial) Se `user_data.recent_loss_signals_count` atingir o limite.
- "utilitarios": Para gerenciar perfil, ver cr√©ditos, pedir ajuda geral sobre o bot.

L√ìGICA DE DECIS√ÉO:
1. Se `user_data.onboarding_completed_at` √© NULO E `is_new_user` √© TRUE ‚Üí "onboarding"
2. Se `user_data.onboarding_completed_at` √© NULO E `is_new_user` √© FALSE (usu√°rio abandonou onboarding) ‚Üí "onboarding"
3. Se `incoming_message` indica inten√ß√£o de sair/voltar/menu (ex: "menu", "sair", "voltar", "op√ß√µes") ‚Üí "menu"
4. Se `user_data.active_analysis_game_id` est√° preenchido:
   - A `incoming_message` √© claramente sobre o `active_analysis_game_id` (verificar no hist√≥rico tamb√©m)? ‚Üí "analise-ativa"
   - A `incoming_message` menciona um jogo DIFERENTE ou pede para analisar outro? ‚Üí "analise-nova" (perguntar confirma√ß√£o de troca se necess√°rio)
   - Caso contr√°rio, se mensagem gen√©rica ‚Üí "menu" (ou "analise-ativa" se o contexto recente for forte)
5. Se `user_data.active_analysis_game_id` √© NULO:
   - A `incoming_message` menciona um jogo espec√≠fico ou pede para analisar um jogo? ‚Üí "analise-nova"
   - A `incoming_message` pede lista de jogos, op√ß√µes gerais? ‚Üí "menu"
6. Se `incoming_message` se refere a perfil, cr√©ditos, ajuda ‚Üí "utilitarios"

Se `user_data.recent_loss_signals_count` >= 3 (ou valor configurado) ‚Üí priorizar "controle-perdas" se a √∫ltima mensagem n√£o foi dele.

FORMATO DA RESPOSTA:
Retorne APENAS o nome do agente em min√∫sculas (ex: "onboarding", "menu").

Executar Workflow (N√≥ N8N): Chamar o workflow do agente determinado pelo Roteador AI, passando o Input Interno Padr√£o.

Sub-fluxo: "Persist√™ncia e Log P√≥s-Agente": Chamado ap√≥s o agente retornar.

Tool Call: Tool:SendMessageToUser: Enviar a response_text (se n√£o for nula) retornada pelo agente (ou pelo sub-fluxo de persist√™ncia) para o usu√°rio.

8. AGENTES ESPECIALIZADOS
Cada agente √© um workflow N8N separado. Abaixo, a estrutura e o core de cada um.

8.1. Agente Onboarding (onboarding.n8n)
Fun√ß√£o: Coletar dados iniciais do usu√°rio, calcular stake e total de apostas di√°rias, e marcar o onboarding como completo. Guiado pelo Scopo detalhado.txt.

Inputs Esperados: user_data, incoming_message, short_term_context_history.

Prompt Core (IA do Agente Onboarding):

Voc√™ √© o agente de onboarding do apostacerta.AI. Sua tarefa √© guiar o usu√°rio pela coleta de dados essenciais de forma amig√°vel e em portugu√™s. Use o `short_term_context_history` para entender o que j√° foi perguntado ou respondido.

DADOS DO USU√ÅRIO (do Supabase):
{{JSON.stringify(user_data, null, 2)}}

HIST√ìRICO RECENTE DA CONVERSA:
{{#each short_term_context_history}}
- {{this}}
{{/each}}

MENSAGEM ATUAL DO USU√ÅRIO: "{{incoming_message}}"

ETAPAS DO ONBOARDING (conforme `Scopo detalhado.txt`, verificar o que falta em `user_data`):
1. Boas-vindas (se for a primeira intera√ß√£o do onboarding).
2. Coletar `bank_value` (Banca Inicial, ex: R$ 1000).
3. Coletar `daily_goal_value` (Meta de Lucro Di√°ria, ex: R$ 100).
4. Coletar `goal_timeframe_days` (Prazo para Meta em Dias, ex: 10 dias).
5. Apresentar Perfis de Risco (Conservador, Equilibrado, Agressivo) e coletar `investor_profile`.
   - Conservador: Stake 2% banca, 5 apostas/dia.
   - Equilibrado: Stake 5% banca, 3 apostas/dia.
   - Agressivo: Stake 10% banca, 1-2 apostas/dia (com alerta de risco).
6. Coletar `favorite_teams` (Array de strings, ex: ["Time A", "Time B"]).
7. Calcular Stake Sugerida e Total de Apostas Di√°rias.
8. Apresentar resumo e finalizar onboarding.

L√ìGICA DE PROCESSAMENTO:
1. Determine qual informa√ß√£o √© a PR√ìXIMA a ser coletada com base nos campos NULOS ou n√£o preenchidos em `user_data` e na ordem das etapas.
2. Analise a `incoming_message` e o `short_term_context_history`:
    - O usu√°rio est√° respondendo √† pergunta anterior? Extraia o valor.
    - O usu√°rio forneceu a informa√ß√£o espontaneamente? Extraia o valor.
3. Se um valor foi extra√≠do:
    - VALIDE o valor (ex: banca √© n√∫mero positivo? Perfil √© uma das op√ß√µes v√°lidas?).
    - Se v√°lido: Prepare `database_updates` para o campo coletado. Determine a PR√ìXIMA informa√ß√£o a ser coletada ou se o onboarding finalizou. Formule uma `response_text` de confirma√ß√£o e para a pr√≥xima pergunta (ou de finaliza√ß√£o).
    - Se inv√°lido: Formule uma `response_text` explicando o erro e pedindo a informa√ß√£o novamente. `database_updates` ser√° nulo.
4. Se NENHUMA informa√ß√£o relevante foi extra√≠da da `incoming_message` para a etapa atual:
    - Formule a `response_text` para PERGUNTAR sobre a informa√ß√£o da etapa atual. `database_updates` ser√° nulo.
5. Se todas as informa√ß√µes foram coletadas:
    - Calcule a stake e o total de apostas (baseado no perfil e banca).
    - Prepare `database_updates` para salvar os c√°lculos, os √∫ltimos dados coletados e `onboarding_completed_at = NOW()`, `remaining_credits = X` (valor inicial de cr√©ditos).
    - Formule uma `response_text` de finaliza√ß√£o do onboarding, apresentando a stake e o total de apostas.
    - Indique `next_module_or_state = "menu"`.

TOOLS A SEREM ORQUESTRADAS (Conceitual):
- Nenhuma tool externa √© chamada diretamente por este prompt. A IA decide o texto e as atualiza√ß√µes. O envio da mensagem e a persist√™ncia s√£o feitos por tools chamadas pelo fluxo N8N ap√≥s este n√≥ de IA.

OUTPUT ESPERADO (JSON):
{
  "response_text": "Sua mensagem para o usu√°rio...",
  "database_updates": { /* objeto para Supabase */ },
  "current_interaction_summary": "Resumo focado desta intera√ß√£o de onboarding.",
  "next_module_or_state": "onboarding" // ou "menu" se finalizado
}

"Tools" Comumente Utilizadas (orquestradas pelo fluxo N8N do agente, n√£o pela IA diretamente):

Tool:FetchUserData (no in√≠cio, feito pelo Hub)

Tool:UpdateUserData (via sub-fluxo "Persist√™ncia e Log")

Tool:SendMessageToUser (para enviar a response_text)

Tool:LogInteraction (via sub-fluxo "Persist√™ncia e Log")

Exemplo de current_interaction_summary Gerado:

"Onboarding: Usu√°rio respondeu banca R$500. Perguntado sobre meta de lucro di√°ria."

"Onboarding: Usu√°rio escolheu perfil 'Conservador'. Apresentado c√°lculo de stake 2%. Perguntado sobre times favoritos."

"Onboarding: Finalizado. Stake 5% (R$50), 3 apostas/dia. Usu√°rio recebeu X cr√©ditos."

Sugest√£o de Fluxo N8N (Alto N√≠vel):

Receber inputs (user_data, incoming_message, short_term_context_history).

N√≥ Advanced AI (Agente Onboarding): Executar o "Prompt Core" acima.

Receber output (response_text, database_updates, current_interaction_summary, next_module_or_state).

Chamar Sub-fluxo "Persist√™ncia e Log P√≥s-Agente": Passar database_updates e current_interaction_summary.

Tool Call: Tool:SendMessageToUser: Enviar response_text (se n√£o nula).

Se next_module_or_state for "menu", o Hub Central pode ser sinalizado para chamar o Agente Menu no pr√≥ximo ciclo se n√£o houver mais intera√ß√£o do Onboarding.

(Estrutura similar ser√° aplicada para os outros agentes: Menu, An√°lise Nova, An√°lise Ativa, Controle de Perdas, Utilit√°rios. Devido √† complexidade, detalharei o Agente Menu como mais um exemplo e listarei os demais de forma mais concisa, focando nas suas particularidades.)

8.2. Agente Menu (menu.n8n)
Fun√ß√£o: Apresentar jogos dispon√≠veis (buscando da Football API), op√ß√µes de perfil, ajuda, e permitir navega√ß√£o. Destacar jogos de times favoritos e jogos j√° analisados (retorno gratuito).

Inputs Esperados: user_data, incoming_message, short_term_context_history.

Prompt Core (IA do Agente Menu):

Voc√™ √© o agente de menu do apostacerta.AI. Sua tarefa √© apresentar as op√ß√µes principais e a lista de jogos de forma clara e √∫til.

DADOS DO USU√ÅRIO:
{{JSON.stringify(user_data, null, 2)}}

HIST√ìRICO RECENTE:
{{#each short_term_context_history}}
- {{this}}
{{/each}}

MENSAGEM DO USU√ÅRIO: "{{incoming_message}}" // Pode ser "menu", ou uma escolha anterior do menu.

JOGOS DISPON√çVEIS (Resultado da Tool:GetFootballGameList):
{{JSON.stringify(jogos_disponiveis_api, null, 2)}} // Array de jogos com IDs, nomes, hor√°rios, status, liga.

L√ìGICA DE PROCESSAMENTO:
1.  Se `incoming_message` for uma escolha espec√≠fica de um jogo listado anteriormente, a inten√ß√£o provavelmente √© "analise-nova" ou "analise-ativa". Este agente deve preparar o output para o Roteador lidar com isso (ou j√° direcionar se a l√≥gica for simples).
2.  Caso contr√°rio, formate a mensagem do menu principal.
3.  Destaque jogos dos `user_data.favorite_teams`.
4.  Marque jogos que j√° est√£o em `user_data.active_analysis_game_id` ou que foram analisados recentemente (verificar `interaction_log` por `event_type='analysis_started'` para o mesmo `game_id_api_football` no dia) com um √≠cone üîÅ (retorno gratuito).
5.  Organize os jogos por ligas principais (conforme `leagues.display_order`).
6.  Mostre hor√°rios e status dos jogos (NS, 1H, HT, 2H, FT).
7.  Apresente outras op√ß√µes: "üìä Meus Dados (Banca/Perfil)", "üí° Como funciona?", "‚ù§Ô∏è Meus Times Favoritos".
8.  Se `user_data.active_analysis_game_name` estiver preenchido, adicione uma op√ß√£o "‚Ü©Ô∏è Continuar an√°lise: {{user_data.active_analysis_game_name}}".

TOOLS A SEREM ORQUESTRADAS (Pelo fluxo N8N antes deste prompt):
- `Tool:GetFootballGameList` (para obter `jogos_disponiveis_api`)
- `Tool:CheckRecentlyAnalyzedGames` (para marcar jogos com üîÅ)

OUTPUT ESPERADO (JSON):
{
  "response_text": "Menu formatado para WhatsApp...",
  "database_updates": null, // Geralmente nulo para o menu, a menos que se atualize algo como 'last_menu_access'
  "current_interaction_summary": "Menu principal apresentado com X jogos. Destaque para Y. Usu√°rio em {{user_data.active_analysis_game_name}} (se houver).",
  "next_module_or_state": "aguardando_escolha_menu"
}

"Tools" Comumente Utilizadas:

Tool:GetFootballGameList (chamada pelo fluxo N8N antes da IA do agente)

Tool:FetchLeaguesInfo (para organizar por ligas)

Tool:CheckRecentlyAnalyzedGames (para identificar jogos para retorno gratuito)

Tool:SendMessageToUser

Tool:LogInteraction

Exemplo de current_interaction_summary Gerado:

"Menu: Apresentados 5 jogos do Brasileir√£o e 3 da Premier League. Jogo 'Flamengo x Palmeiras' marcado como retorno gratuito."

"Menu: Usu√°rio visualizou o menu principal. Nenhuma an√°lise ativa."

Sugest√£o de Fluxo N8N (Alto N√≠vel):

Receber inputs.

Tool Call: Tool:GetFootballGameList (par√¢metros: ligas priorit√°rias, status dos jogos 'NS', 'LIVE', etc.).

Tool Call: Tool:CheckRecentlyAnalyzedGames (input: user_id, lista de jogos da tool anterior; output: lista de jogos com flag is_returnable).

N√≥ Advanced AI (Agente Menu): Executar "Prompt Core", passando a lista de jogos enriquecida.

Processar output do agente e chamar sub-fluxos de persist√™ncia e envio de mensagem.

8.3. Agente An√°lise Nova (analise-nova.n8n)
Fun√ß√£o: Identificar o jogo que o usu√°rio quer analisar, validar e consumir cr√©dito, buscar dados do jogo, chamar IA para an√°lise, apresentar a an√°lise.

Particularidades:

Verifica user_data.remaining_credits. Se > 0, consome 1.

Pede confirma√ß√£o antes de consumir cr√©dito se for uma troca de an√°lise ativa.

Atualiza user_data.active_analysis_game_id e active_analysis_details.

Usa Tool:GetFootballGameStatistics e Tool:GenerateSportAnalysisAI (que √© um prompt especializado para a IA de an√°lise esportiva).

current_interaction_summary Exemplo: "An√°lise Nova: Jogo 'Corinthians x S√£o Paulo' identificado. Cr√©dito validado (restam 2). An√°lise gerada e enviada. Stake sugerida: 5%."

8.4. Agente An√°lise Ativa (analise-ativa.n8n)
Fun√ß√£o: Continuar uma an√°lise de jogo j√° iniciada e paga. N√£o consome cr√©dito. Responde a perguntas contextuais sobre o user_data.active_analysis_game_id.

Particularidades:

Foco principal no user_data.active_analysis_details e short_term_context_history para entender as perguntas do usu√°rio sobre o jogo ativo.

Pode usar Tool:GetFootballGameStatistics para buscar dados atualizados se o jogo estiver ao vivo.

Usa Tool:GenerateSportAnalysisAI para responder perguntas espec√≠ficas ou fornecer mais insights.

Se o usu√°rio quiser sair, pergunta sobre o resultado da aposta (Tool:AskBetResult).

current_interaction_summary Exemplo: "An√°lise Ativa (Jogo X): Usu√°rio perguntou sobre estat√≠sticas de posse de bola. Resposta fornecida."

8.5. Agente Controle de Perdas (controle-perdas.n8n)
Fun√ß√£o: Monitorar user_data.recent_loss_signals_count. Se atingir o limite (ex: 3), envia mensagem de alerta e sugest√£o de pausa.

Particularidades:

Pode ser acionado pelo Roteador ou por um gatilho ap√≥s o usu√°rio reportar uma perda (via Agente An√°lise Ativa ou Utilit√°rios).

Prompt da IA focado em empatia e conselhos de gest√£o emocional.

Pode ter uma database_update para resetar recent_loss_signals_count ap√≥s um tempo ou confirma√ß√£o do usu√°rio.

current_interaction_summary Exemplo: "Controle Perdas: Usu√°rio atingiu 3 perdas. Mensagem de alerta e pausa estrat√©gica enviada."

8.6. Agente Utilit√°rios (utilitarios.n8n)
Fun√ß√£o: Lidar com solicita√ß√µes de visualiza√ß√£o/edi√ß√£o de perfil (bank_value, investor_profile, favorite_teams), consulta de cr√©ditos, ajuda sobre o bot.

Particularidades:

A IA do agente interpreta qual utilit√°rio o usu√°rio deseja.

Pode precisar de m√∫ltiplos turnos para edi√ß√£o de dados (ex: perguntar novo valor da banca, confirmar).

Para "Como funciona?", apresenta texto explicativo sobre cr√©ditos, an√°lises, etc.

current_interaction_summary Exemplo: "Utilit√°rios: Usu√°rio visualizou perfil. Banca: R$X, Perfil: Y." ou "Utilit√°rios: Usu√°rio atualizou times favoritos para Z, W."

9. CAT√ÅLOGO DE "TOOLS" (Sub-Fluxos N8N Reutiliz√°veis ou N√≥s Especializados)
Estas s√£o as "ferramentas" conceituais que os fluxos dos agentes N8N ir√£o orquestrar. Cada uma pode ser um sub-workflow N8N dedicado ou um n√≥ N8N espec√≠fico (Supabase, HTTP Request, Function) devidamente configurado.

Tool:FetchOrCreateUser

Responsabilidade: Verifica se um usu√°rio com o whatsapp_id fornecido existe na tabela users. Se existir, retorna seus dados. Se n√£o, cria um novo usu√°rio com valores default (ex: push_name, remaining_credits inicial, onboarding_completed_at = NULL) e retorna os dados do novo usu√°rio.

Inputs: whatsapp_id (String), push_name (String, opcional).

Output: { user_data (Object), is_new_user (Boolean) }.

N√≥s N8N: Supabase (SELECT, INSERT).

Tool:FetchUserData

Responsabilidade: Busca todos os dados de um usu√°rio espec√≠fico da tabela users.

Inputs: user_id (UUID).

Output: { user_data (Object) }.

N√≥s N8N: Supabase (SELECT).

Tool:UpdateUserData

Responsabilidade: Atualiza campos espec√≠ficos de um usu√°rio na tabela users. Usado pelo sub-fluxo "Persist√™ncia e Log".

Inputs: user_id (UUID), fields_to_update (Object).

Output: { status (String), updated_user_data (Object, opcional) }.

N√≥s N8N: Supabase (UPDATE).

Tool:FetchInteractionHistory

Responsabilidade: Busca os N current_interaction_summary mais recentes para um usu√°rio da tabela interaction_log.

Inputs: user_id (UUID), limit (Integer, default 3-5).

Output: { short_term_context_history (Array[String]) }.

N√≥s N8N: Supabase (SELECT com ORDER BY timestamp DESC, LIMIT).

Tool:LogInteractionEvent

Responsabilidade: Insere um novo registro na tabela interaction_log. Usado pelo sub-fluxo "Persist√™ncia e Log".

Inputs: user_id (UUID), event_type (String), summary (String).

Output: { status (String) }.

N√≥s N8N: Supabase (INSERT).

Tool:SendMessageToUser

Responsabilidade: Envia uma mensagem de texto para o usu√°rio via Evolution API.

Inputs: whatsapp_id (String), text_message (String).

Output: { status (String), message_id_api (String, opcional) }.

N√≥s N8N: HTTP Request (para Evolution API).

Tool:GetFootballGameList

Responsabilidade: Busca a lista de jogos de futebol (das ligas configuradas, com status espec√≠fico) da Football API-Sports.

Inputs: league_ids (Array[String]), date (String, YYYY-MM-DD), status (String, ex: "NS,LIVE"), timezone (String).

Output: { jogos_disponiveis_api (Array[Object]) } (cada objeto com fixture_id, home_team, away_team, league_name, event_timestamp, status, etc.).

N√≥s N8N: HTTP Request (para Football API-Sports).

Tool:GetFootballGameStatistics

Responsabilidade: Busca estat√≠sticas detalhadas para um jogo espec√≠fico da Football API-Sports.

Inputs: fixture_id (String).

Output: { game_statistics (Object) }.

N√≥s N8N: HTTP Request (para Football API-Sports).

Tool:CheckRecentlyAnalyzedGames

Responsabilidade: Verifica, para uma lista de jogos, quais j√° foram analisados pelo usu√°rio recentemente (para marcar como retorno gratuito). Consulta interaction_log.

Inputs: user_id (UUID), game_list (Array[Object]).

Output: game_list_with_return_flag (Array[Object]).

N√≥s N8N: Supabase (SELECT), Function Node (para l√≥gica de verifica√ß√£o).

Tool:ConsumeCredit

Responsabilidade: Decrementa remaining_credits do usu√°rio.

Inputs: user_id (UUID).

Output: { status (String), new_credit_balance (Integer) }.

N√≥s N8N: Supabase (UPDATE users SET remaining_credits = remaining_credits - 1).

Tool:GenerateSportAnalysisAI

Responsabilidade: Submete dados de um jogo e perfil do usu√°rio a um modelo de IA especializado para gerar uma an√°lise esportiva, recomenda√ß√£o ou responder a uma pergunta espec√≠fica. (Este √© um prompt de IA mais complexo, ver se√ß√£o "Prompts Especializados").

Inputs: game_data (Object), user_profile (Object), analysis_focus_question (String, opcional).

Output: { analysis_text (String), recommendation (Object, opcional) }.

N√≥s N8N: Advanced AI Node.

Tool:AskBetResult

Responsabilidade: Envia uma mensagem ao usu√°rio perguntando o resultado da aposta em um jogo que ele estava analisando.

Inputs: whatsapp_id (String), game_name (String).

Output: { status (String) }.

N√≥s N8N: Tool:SendMessageToUser.

10. SISTEMA DE CR√âDITOS
(Conforme o blueprint original e Scopo detalhado.txt)

Consumo: 1 cr√©dito por NOVA an√°lise de jogo (quando Tool:GetFootballGameStatistics ou Tool:GenerateSportAnalysisAI √© chamada pela primeira vez para um fixture_id espec√≠fico para aquele usu√°rio, no dia ou per√≠odo relevante).

Retorno Gratuito: An√°lise ativa ou retorno a um jogo j√° pago (identificado por Tool:CheckRecentlyAnalyzedGames) n√£o consome cr√©dito adicional.

Reset/Recarga: Cr√©ditos podem ser resetados diariamente (via reset-credits.n8n agendado) ou atribu√≠dos conforme planos/regras de neg√≥cio (ex: X cr√©ditos no onboarding). Tabela users.credits_last_reset_at pode controlar o reset di√°rio.

Controle: Tool:ConsumeCredit √© chamada pelo Agente "An√°lise Nova". O Agente verifica user_data.remaining_credits antes.

11. ESTRUTURA DOS WORKFLOWS N8N (Organiza√ß√£o de Arquivos)
(Conforme o blueprint original)

workflows/
‚îú‚îÄ‚îÄ 00-webhook-evolution.n8n   # Recebe de Evolution, passa para o Hub
‚îú‚îÄ‚îÄ 01-hub-central.n8n         # Roteador AI principal
‚îú‚îÄ‚îÄ agentes/
‚îÇ   ‚îú‚îÄ‚îÄ onboarding.n8n
‚îÇ   ‚îú‚îÄ‚îÄ menu.n8n
‚îÇ   ‚îú‚îÄ‚îÄ analise-nova.n8n
‚îÇ   ‚îú‚îÄ‚îÄ analise-ativa.n8n
‚îÇ   ‚îú‚îÄ‚îÄ utilitarios.n8n
‚îÇ   ‚îî‚îÄ‚îÄ controle-perdas.n8n
‚îú‚îÄ‚îÄ tools/                     # Sub-fluxos reutiliz√°veis (Tools)
‚îÇ   ‚îú‚îÄ‚îÄ supabase-fetch-user.n8n
‚îÇ   ‚îú‚îÄ‚îÄ supabase-update-user.n8n
‚îÇ   ‚îú‚îÄ‚îÄ supabase-log-interaction.n8n
‚îÇ   ‚îú‚îÄ‚îÄ evolution-send-message.n8n
‚îÇ   ‚îú‚îÄ‚îÄ football-api-get-games.n8n
‚îÇ   ‚îî‚îÄ‚îÄ football-api-get-stats.n8n
‚îÇ   ‚îî‚îÄ‚îÄ ai-generate-sport-analysis.n8n
‚îú‚îÄ‚îÄ subfluxos_comuns/
‚îÇ   ‚îî‚îÄ‚îÄ persistencia-e-log-pos-agente.n8n
‚îî‚îÄ‚îÄ scheduled/
    ‚îî‚îÄ‚îÄ reset-credits.n8n

12. CONFIGURA√á√ÉO ADVANCED AI NODES
(Conforme o blueprint original, ajustar conforme o modelo de IA escolhido - Gemini, GPT, Claude)

Provider: google-gemini, openai, anthropic.

Model: Especificar o modelo (ex: gemini-pro, gpt-4-turbo, claude-3-opus).

Temperature:

Para Roteamento e decis√µes l√≥gicas: Baixa (ex: 0.1 - 0.3).

Para Gera√ß√£o de An√°lise Esportiva e Respostas Criativas: Moderada (ex: 0.5 - 0.7).

Max Tokens: Ajustar conforme a complexidade da tarefa e o output esperado.

Response Format: json_object quando a IA do agente precisa retornar a estrutura padronizada (response_text, database_updates, current_interaction_summary). text para respostas mais diretas dentro de algumas tools.

13. PROMPTS ESPECIALIZADOS (Exemplos)
Prompt para Tool:GenerateSportAnalysisAI
(Este √© um prompt mais complexo, usado pela tool que o "Agente An√°lise Nova" ou "An√°lise Ativa" orquestraria)

Voc√™ √© um analista esportivo expert do apostacerta.AI. Sua tarefa √© fornecer uma an√°lise detalhada e imparcial do jogo de futebol solicitado, ou responder a uma pergunta espec√≠fica sobre ele, considerando o perfil do usu√°rio.

JOGO PARA AN√ÅLISE:
{{JSON.stringify(game_data_from_api_sports, null, 2)}}
/* game_data_from_api_sports inclui:
   - Informa√ß√µes da partida (times, liga, data, placar atual se ao vivo)
   - Estat√≠sticas H2H recentes
   - Forma recente das equipes (√∫ltimos 5-10 jogos, resultados, gols)
   - Estat√≠sticas detalhadas da partida (se dispon√≠veis/ao vivo: posse, chutes, cantos, cart√µes, etc.)
   - Desfalques importantes (se dispon√≠veis)
*/

PERFIL DO USU√ÅRIO:
- Banca Atual: R$ {{user_data.bank_value}}
- Perfil de Risco: {{user_data.investor_profile}} (Conservador, Equilibrado, Agressivo)
- Stake Sugerida (calculada no onboarding): {{user_data.stake_sugerida_percentual}}% (aproximadamente R$ {{user_data.stake_sugerida_valor}})
- Times Favoritos: {{JSON.stringify(user_data.favorite_teams)}}

HIST√ìRICO RECENTE DA CONVERSA SOBRE ESTE JOGO (se houver):
{{#each short_term_context_history_for_this_game}}
- {{this}}
{{/each}}

FOCO DA AN√ÅLISE / PERGUNTA DO USU√ÅRIO (se aplic√°vel):
"{{analysis_focus_question || 'Forne√ßa uma an√°lise geral e identifique uma oportunidade de aposta.'}}"

INSTRU√á√ïES PARA A AN√ÅLISE:
1.  **Contexto do Confronto (2-3 linhas):** Import√¢ncia do jogo, rivalidade, situa√ß√£o na tabela.
2.  **An√°lise das Equipes:**
    * Desempenho recente, pontos fortes e fracos.
    * Como as estat√≠sticas (posse, chutes, xG se dispon√≠vel) refletem seu estilo de jogo.
    * Impacto de desfalques.
3.  **Estat√≠sticas Chave Relevantes:** Destaque os dados mais importantes do `game_data_from_api_sports` que suportam sua an√°lise.
4.  **Identifica√ß√£o de Oportunidade (se o foco for an√°lise geral):**
    * Sugira um mercado de aposta (ex: Resultado Final, Ambas Marcam, Total de Gols Over/Under, Handicap Asi√°tico, Marcadores).
    * Justifique a escolha com base na an√°lise e estat√≠sticas.
    * Indique uma faixa de odd que consideraria de valor (ex: "Odd m√≠nima sugerida: 1.85"). *N√£o prometa ganhos.*
5.  **Recomenda√ß√£o de Stake (se aplic√°vel e uma oportunidade for identificada):**
    * Sugira um percentual da stake padr√£o do usu√°rio (ex: 0.5x, 1x, 1.5x da stake calculada no onboarding), justificando com base no n√≠vel de confian√ßa e no perfil de risco.
    * Ex: "Para seu perfil {{user_data.investor_profile}}, uma stake de {{0.5 * user_data.stake_sugerida_percentual}}% da sua banca (R$ {{0.5 * user_data.stake_sugerida_valor}}) seria prudente para esta aposta."
6.  **Resposta √† Pergunta Espec√≠fica (se `analysis_focus_question` existir):** Responda diretamente √† pergunta do usu√°rio usando os dados dispon√≠veis.
7.  **Alerta de Gest√£o de Banca:** SEMPRE inclua uma frase lembrando da import√¢ncia do gerenciamento de banca e de apostar com responsabilidade.
8.  **Pergunta Engajante (Opcional, se for an√°lise geral):** Termine com uma pergunta para incentivar o usu√°rio a explorar mais algum aspecto (ex: "Gostaria de analisar as estat√≠sticas de escanteios ou o desempenho do artilheiro da equipe X?").

TONE E ESTILO:
- Objetivo, anal√≠tico e baseado em dados.
- Imparcial, mesmo que um dos times seja favorito do usu√°rio.
- Linguagem clara e acess√≠vel para apostadores.
- Evite jarg√µes excessivos sem explica√ß√£o.
- NUNCA garanta resultados ou lucros. Enfatize que s√£o an√°lises e sugest√µes.

FORMATO DA RESPOSTA (TEXTO):
Produza um texto corrido e bem formatado para WhatsApp. Use emojis com modera√ß√£o para melhorar a legibilidade.

14. SISTEMA DE MONITORAMENTO
(Conforme o blueprint original e Scopo detalhado.txt)

Logs Essenciais (Tabela interaction_log):

user_id, timestamp, event_type (ex: onboarding_step, menu_displayed, analysis_requested, analysis_generated, credit_consumed, error_api_football, user_message_unclear), details (contendo o current_interaction_summary e outros metadados relevantes da intera√ß√£o).

M√©tricas Importantes (a serem extra√≠das dos logs):

Tempo de resposta por agente/tool.

Taxa de conclus√£o do onboarding.

Uso de cr√©ditos por usu√°rio/dia.

Jogos/Ligas mais analisados.

Taxa de "retorno gratuito" a an√°lises.

Engajamento com o Agente de Controle de Perdas.

Pontos de abandono no funil de intera√ß√£o.

15. PLANO DE IMPLEMENTA√á√ÉO (Fases Sugeridas)
(Adaptado do blueprint original e Scopo detalhado.txt)

Fase 0: Setup e Funda√ß√£o (J√° parcialmente conclu√≠do)

[X] Configurar Supabase (schema de c√≥digo postgresql.txt aplicado).

[X] Configurar Evolution API (pronta para integra√ß√£o).

[ ] Configurar N8N com n√≥s Advanced AI e acesso √†s APIs.

[ ] Configurar Football API (chave e plano).

[ ] Criar workflow 00-webhook-evolution.n8n.

[ ] Implementar Tool:FetchOrCreateUser e Tool:FetchInteractionHistory.

Fase 1: Hub Central + Roteador (Dia 1-2)

[ ] Criar workflow 01-hub-central.n8n.

[ ] Implementar Advanced AI Roteador (Prompt Core e l√≥gica de decis√£o).

[ ] Implementar sub-fluxo persistencia-e-log-pos-agente.n8n.

[ ] Implementar Tool:SendMessageToUser.

[ ] Testar roteamento b√°sico com dados mock para user_data e short_term_context_history.

Fase 2: Agente Onboarding (Dia 3-5)

[ ] Criar workflow agentes/onboarding.n8n.

[ ] Implementar o "Prompt Core" da IA do Agente Onboarding.

[ ] Desenvolver l√≥gica N8N para gerenciar as etapas do onboarding (coleta sequencial, valida√ß√£o).

[ ] Integrar com Tool:UpdateUserData (via sub-fluxo de persist√™ncia).

[ ] Implementar c√°lculo de stake e apostas di√°rias.

[ ] Testes ponta a ponta do onboarding completo.

Fase 3: Agente Menu e Listagem de Jogos (Dia 6-7)

[ ] Criar workflow agentes/menu.n8n.

[ ] Implementar Tool:GetFootballGameList e Tool:CheckRecentlyAnalyzedGames.

[ ] Implementar o "Prompt Core" da IA do Agente Menu para formata√ß√£o da lista de jogos e op√ß√µes.

[ ] Testar apresenta√ß√£o do menu, destaque de favoritos e jogos retorn√°veis.

Fase 4: Agentes de An√°lise (Nova e Ativa) e Sistema de Cr√©ditos (Dia 8-11)

[ ] Criar workflows agentes/analise-nova.n8n e agentes/analise-ativa.n8n.

[ ] Implementar Tool:ConsumeCredit.

[ ] Implementar Tool:GetFootballGameStatistics.

[ ] Implementar Tool:GenerateSportAnalysisAI (com o prompt especializado).

[ ] Desenvolver "Prompt Core" e l√≥gica N8N para ambos os agentes de an√°lise.

[ ] Gerenciar estado de active_analysis_game_id e active_analysis_details.

[ ] Testar fluxo completo de an√°lise nova (com consumo de cr√©dito) e an√°lise ativa (gratuita, contextual).

Fase 5: Agente Controle de Perdas e Utilit√°rios (Dia 12-13)

[ ] Criar workflows agentes/controle-perdas.n8n e agentes/utilitarios.n8n.

[ ] Implementar l√≥gica de gatilho para controle de perdas.

[ ] Desenvolver "Prompt Core" e l√≥gica N8N para estes agentes.

[ ] Testar alertas de perda e funcionalidades de perfil/ajuda.

Fase 6: Testes Integrados, Refinamento de Prompts e Otimiza√ß√£o (Dia 14-15)

[ ] Testar todos os fluxos de ponta a ponta com m√∫ltiplos cen√°rios.

[ ] Ajustar prompts de IA com base nos resultados e qualidade das respostas.

[ ] Otimizar performance dos workflows N8N.

[ ] Revisar tratamento de erros e mensagens ao usu√°rio.

Fase 7: Documenta√ß√£o Final e Prepara√ß√£o para Deploy (Dia 16)

[ ] Finalizar documenta√ß√£o interna dos workflows N8N.

[ ] Preparar vari√°veis de ambiente para produ√ß√£o.

16. CHECKLIST DE VALIDA√á√ÉO (V1.1)
(Conforme Scopo detalhado.txt e este blueprint)

Funcionalidades Core:

[ ] Usu√°rio completa onboarding (banca, meta, prazo, perfil, times), dados salvos, stake calculada.

[ ] Roteador IA direciona corretamente para cada agente com base no contexto.

[ ] short_term_context_history √© corretamente carregado e utilizado pelos agentes.

[ ] current_interaction_summary √© gerado de forma concisa e √∫til por cada agente.

[ ] Sub-fluxo "Persist√™ncia e Log P√≥s-Agente" funciona corretamente.

[ ] Menu mostra jogos (Football API), destaca favoritos e retornos gratuitos (üîÅ).

[ ] Nova an√°lise consome 1 cr√©dito, busca estat√≠sticas, IA gera an√°lise e √© enviada.

[ ] Retorno √† an√°lise ativa √© gratuito e contextual.

[ ] Agente Controle de Perdas alerta ap√≥s X perdas.

[ ] Agente Utilit√°rios permite ver/alterar perfil e obter ajuda.

[ ] Dados persistem corretamente no Supabase conforme c√≥digo postgresql.txt.

[ ] Integra√ß√£o com WhatsApp via Evolution API funciona para envio e recebimento.

Performance e Usabilidade:

[ ] Tempo de resposta aceit√°vel (< 5-10 segundos para intera√ß√µes complexas com IA).

[ ] Mensagens bem formatadas e claras no WhatsApp.

[ ] Tratamento de erros amig√°vel (falhas de API, input inv√°lido).

[ ] Logs de monitoramento (interaction_log) s√£o abrangentes.

Seguran√ßa e Dados:

[ ] RLS (Row Level Security) ativo e funcional no Supabase (conforme c√≥digo postgresql.txt).

[ ] Chaves de API (Football API, IA, Evolution) protegidas como vari√°veis de ambiente no N8N.

[ ] Dados do usu√°rio isolados corretamente.

17. RECURSOS E REFER√äNCIAS
(Conforme o blueprint original)

APIs Utilizadas: Football API-Sports, Supabase, Evolution API, OpenAI/Claude/Gemini.

Documenta√ß√£o N8N: Advanced AI Nodes, HTTP Request, Supabase Node, Webhooks, Sub-Workflows (Execute Workflow).

18. TROUBLESHOOTING COMUM
(Conforme o blueprint original)

Timeout APIs Externas: Aumentar timeout nos n√≥s HTTP Request; implementar retentativas com backoff exponencial.

Erro Supabase RLS: Verificar pol√≠ticas de seguran√ßa no c√≥digo postgresql.txt e se o usu√°rio da API N8N tem as permiss√µes corretas.

WhatsApp n√£o recebe/envia: Verificar webhook da Evolution API, status da inst√¢ncia, formato do payload.

IA n√£o responde JSON (quando esperado): Ajustar prompt (pedir explicitamente JSON), verificar temperature, maxTokens, ou usar n√≥s N8N para extrair/transformar a resposta da IA.

Contexto da IA Incorreto: Depurar o short_term_context_history e os user_data passados para o prompt. Verificar a qualidade do current_interaction_summary.

19. PR√ìXIMOS PASSOS PARA COME√áAR (Com este Blueprint)
Revis√£o Completa: Revise este Blueprint Mestre V1.1 para garantir que todos os aspectos est√£o cobertos e claros.

Configura√ß√£o do Ambiente N8N: Certifique-se de que o N8N est√° pronto, com acesso √†s APIs e n√≥s necess√°rios.

Implementa√ß√£o Incremental: Siga o Plano de Implementa√ß√£o fase por fase.

Comece pelo 00-webhook-evolution.n8n e 01-hub-central.n8n, incluindo as "Tools" b√°sicas de busca de usu√°rio e hist√≥rico.

Implemente um agente por vez, testando-o exaustivamente antes de passar para o pr√≥ximo.

Foco nas "Tools" Primeiro: Muitas "Tools" s√£o sub-fluxos gen√©ricos. Implement√°-las e test√°-las individualmente pode acelerar o desenvolvimento dos agentes.

Itera√ß√£o nos Prompts: Os prompts da IA (Roteador, Agentes, An√°lise Esportiva) provavelmente necessitar√£o de v√°rias itera√ß√µes e testes para alcan√ßar a qualidade desejada.

Valida√ß√£o Cont√≠nua: Use o Checklist de Valida√ß√£o ao final de cada fase e antes do deploy final.

IMPORTANTE: Este blueprint √© um guia vivo. Conforme o projeto evolui e novos aprendizados surgem, ele pode (e deve) ser atualizado para refletir o estado mais recente e as melhores pr√°ticas identificadas.


Este Blueprint Mestre V1.1 agora est√° significativamente mais detalhado e incorpora todos os princ√≠pios e estruturas que discutimos. Ele deve fornecer uma base s√≥lida para qualquer IA ou desenvolvedor continuar o projeto ApostaCerta.AI com clareza e consist√™ncia.

O que voc√™ acha? H√° algo mais que gostaria de adicionar ou refinar neste momento antes de considerarmos esta vers√£o do blueprint pronta para guiar a implementa√ß√£o?
